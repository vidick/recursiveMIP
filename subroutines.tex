%!TEX root = main.tex

\section{Subroutines of the VTM $V_{UEVC}$}

In this section detail the checks that are performed in the case $r>1$ of the VTM $V_{UEVC}$ described in Figure~\ref{fig:lambda}. Each subroutine corresponds to a test that is performed by the extended verifier associated with the VTM, such that, provers passing the test with high enough probability must satisfy a certain rigidity property. The tests, together with the associated rigidity properties, are described in the following subsections. 

Furthermore, the random choices made by the subroutines below are based on the random string $w$ that is passed in as input. 

\paragraph{Notation} Each of the subroutines follows a similar structure, summarized in Figure~\ref{fig:check_structure}. The subroutines all take the same input $(1^n,w,r,G,V,M)$. $w$ is a string that is used to make all random choices. $r$ is an integer that indicates a ``level'' for the verifier. It is used to parametrize a set $\mathcal{P}_r$ of $\kappa(r)$ provers, each playing different roles. 

The subroutines describe tests that are to be performed by the $r$-th level verifier. The tests are meant to enforce that the provers hold a history state for the protocol that would be carried out by the $(r-1)$-th level verifier and the set of provers $\mathcal{P}_{r-1} \subseteq \mathcal{P}_r$. 

The provers in the set $\mathcal{P}_r$ have the following labels and associated roles:
\begin{itemize}
	\item $PV$: This prover plays the role of $UEVC_{N,r-1}$
	\item $PP_1,\ldots,PP_{\kappa(r-1)}$: These provers play the role of the $\kappa(r-1)$ provers $\mathcal{P}_{r-1}$ that the $(r-1)$-th level verifier interacts with.
	\item $PA$: This is an ancillary prover
%	\item $PA_1,\ldots,PA_{\kappa(r-1)}$: These are ancillary provers.
\end{itemize}
%We match the ancillary provers with the other provers in $\mathcal{P}_r$ in the following way: the ancillary prover corresponding to $PV$ is $PA_V$, and the ancillary prover corresponding to $PP_i$ is $PA_i$ for all $i$. 
We will let $\mathcal{R}_r$ denote the set $\{PV,PP_1,\ldots,PP_{\kappa(r-1)} \} \subset \mathcal{P}_r$ to denote the set of non-ancillary provers. Furthermore, we order the provers in $\mathcal{P}_r$ for notational convenience: $PV < PP_1 < \cdots < PP_{\kappa(r-1)} < PA$. 

We use the label $P$ to refer to an arbitrary prover $P\in\mathcal{P}_r$. 

In what follows we use the notation $\sC,\sV_{in},\sV_{work}$, and $\sM_i$ introduced in Section~\label{sec:specs} to refer to registers on which the circuit $UEVC_{n,r}$ associated with the VTM acts on. In addition, we write $\sC_{r-1}$, $\sV_{r-1,in},\sV_{r-1,work}$, and $\{ \sM_{r-1,i} \}_i$ to denote the registers that $UEVC_{N,r-1}$ acts on. We let $\sM_{r-1}$ denote the union of $\{ \sM_{r-1,i} \}_i$, and we let $\sV_{r-1}$ denote the union of $\sC_{r-1}$, $\sV_{r-1,in},\sV_{r-1,work}$, and $\sM_{r-1}$. 

For a given register $\sR$, we write $\supp(\sR)$ to denote the set of qubits in $\sR$.






\vspace{10pt}
\begin{center}
\begin{mdframed}
Inptut: $(1^n,w,r,G,V,M)$\\
  $w$ is a random string, $r$ the level of the verifier, $G$ a GTM, $V$ a VTM, and $M$ a TM.\\
Each subroutine is decomposed in three phases. Each phase reads some tapes of the VTM and writes on some others. The phases are the following: 
	\begin{enumerate}
		\item (\textsc{ClockMeasurement}) In this phase the subroutine writes the description of a cicruit describing a quantum measurement on the measurement specification tape. The measurement applies to a clock register $\sC$, divided into two parts, $\sC_{p}$ and $\sC_{mip}$. To describe the measurements, for any integer $t$ we use the notation 
$$\ket{\pm_t} \,=\, \frac{1}{\sqrt{2}}\big(\ket{t}\pm\ket{t+1}\big)\;.$$
	\item (\textsc{GenQuestions}) In this phase the subroutine has access to the measurement outcome tape, and writes questions on the player question tape. The questions are denoted  by $q_V$, $q_{P,1},\ldots,q_{P,\kappa(r-1)}$, $q_{A,1},\ldots,q_{A,\sigma(r)}$, where the subscript indicates the label of the prover to which the question is to be sent. 
		\item (\textsc{CheckAnswers}) In this phase the subroutine has access to the player answer tape, and writes on the referee decision tape. The player answer tape is assumed to contain answers labeled as $a_V$, $a_{P,1},\ldots,a_{P,\kappa(r-1)}$, $a_{A,1},\ldots,a_{A,\sigma(r)}$, where the subscript indicates the label of the prover from which the answer is obtained.
	\end{enumerate}    
\end{mdframed}

\end{center}
\begin{figure}[H]
\caption{Template for each of the subroutines of $V_{UEVC}$}
\label{fig:check_structure}
\end{figure}





%%%%%%%%%%%%%%%%%%%%%%%%%%		PAULI CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Pauli check}
\label{sec:pauli_check}

The \textsc{Pauli Check} subroutine describes an interaction between the $r$-th level verifier and the provers $\mathcal{P}_r$. In the subroutine, the verifier will call prover $PA$ ``player A'', and then pick a random prover from the set $\mathcal{R}_r = \{ PV, PP_1,\ldots,PP_{\kappa(r-1)}\}$, and call this prover ``player B''. For the rest of the subroutine, the verifier will only interact with players A and B. 
%provers $PA_1$ and $PV$. In the description of the check we refer to the former as ``player A'' and to the latter as ``player B''. 

In the subroutine, the verifier performs one of several tests, chosen uniformly at random. The tests are summarized in Figure~\ref{fig:pauli_check} in an ``operational'' language. Formally, each test should be put in the form of actions for the VTM, following the template introduced in Figure~\ref{fig:check_structure}. 

\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,r,G,V,M)$ \\
    \\
	Let player A denote prover $PA$.
    Choose a random prover $P^*$ from the set of non-ancillary provers $\mathcal{R}_r$, and let player B denote prover $P^*$. \\
%    Let player A denote the ancillary prover corresponding to $P$ (see the Notation subsection above). \\
    \\
    Perform one of the tests uniformly at random. Each test should be interpreted as a three-phase procedure, as described in Figure~\ref{fig:check_structure}. \hnote{This is already stated in the paragraph above the box.} The \textsc{ClockMeasurement} phase involves a measurement on the clock register $\reg{C}_p$ of dimension $2(\kappa(r-1)+1)(N+1)$, with computational basis labeled by 
    \[
    (d,t,P)\in \{0,1\}\times \{0,\ldots,N\} \times \mathcal{R}_r .
    \]
    
	\begin{enumerate}
 \item \emph{(EPR test)} Measure register $\reg{C}_{p}$ in the computational basis. Accept if the outcome $(t,P)\neq (0,P^*)$ (we do not care what $d$ is). Otherwise, execute the $2N$-qubit EPR test with A and B, where A's questions are augmented by $P^*$ (i.e. which prover that player B corresponds to). \\
\tnote{Intended goal: Checks that whenever A or B is sent an EPR question, it applies the corresponding Pauli observable, independently of any other question asked. A consequence of this test and the form of questions to player B is that we can write the observables it applies as a product of an observable for the EPR question, and an observable for the Pauli question, where each observable only depends on the corresponding question (and not on the pair of questions).}

\item \emph{(Propagation check)} Let $t\in\{0,\ldots,N-1\}$ and $d\in\{0,1\}$ be chosen uniformly at random. Measure register $\reg{C}_{p}$ using the three-outcome POVM
$$\Set{ \Pi^0 = \proj{d} \otimes \proj{+_t} \otimes \proj{P^*},\; \Pi^1 =  \proj{d} \otimes \proj{-_t} \otimes \proj{P^*},\;\Pi^2 = \Id - \Pi^0-\Pi^1 }.$$
If the outcome is $c=2$, accept. Otherwise, if $d=0$, send $B$ the question $CZ_{t}$. If $d=1$, send B the question $CX_t$. Check that the answer reported by B equals $(-1)^c$, where $c\in\{0,1\}$ is the outcome obtained by the verifier.\\
\tnote{Intended goal: Check that the state shared by the players takes the form of a history state, where the reflection applied on Bob's registers $BB'$ at step $2$ only acts on register $B$ and the appropriate qubit of $B'$.}

\item \emph{(CTL check)} Measure register $\reg{C}_{p}$ in the computational basis to obtain an outcome $(d,t,P)$. If $P \neq P^*$, then accept. Send player A the EPR question $X'_{N+t}$ ($d=1$) or $X'_t$ ($d=0$), as well as the identity of player B.  Send player B the same EPR question as player A, as well as the Pauli question $X_t$ (if $d=1)$ or $Z_t$ (if $d=0$).  Reject if the product of the three answer bits received is not $1$.
%\item Send player B the same EPR question as player A, as well as the CTL-Pauli question $CX_t$ ($d=1)$ or $CZ_t$ ($d=0$).  Reject if B's second answer is not $1$, or if A's answer and B's first answer do not match.
\tnote{Intended goal: Check that the reflection applied by B on question $CX_i$ (resp. $CZ_j$) is a controlled observable, controlled on the qubit in register $B'_i$ (resp. $B'_{n+j}$) only, and that it matches the observable applies on question $X_i$ (resp. $Z_j$), which only acts on register $B$.}

\item{\emph{(Pauli relation check)}} Measure register $\reg{C}_p$  in the computational basis to obtain an outcome $(d,t,P)$. Accept if $(d,t,P)\neq (1,N,P^*)$. Perform either of the following, with probability half each:
\begin{enumerate}
\item Choose $i\in\{1,\ldots,N\}$ uniformly at random. Send player A the EPR question $X'_i$ with the identity of player B. Send player B the same EPR question as player A, as well as the Pauli question $X_i$. Reject if the product of the three answer bits is not $+1$. 
\item Choose $j\in\{1,\ldots,N\}$ uniformly at random. Send player A the EPR question $(Z'_j,X'_{j+N})$  with the identity of player B. Send player B the EPR question $X'_{j+N}$, as well as the Pauli question $Z_j$. Reject if the product of all answer bits is not $+1$. 
\end{enumerate}
\tnote{Intended goal: check the Pauli relations, in the format of Lemma~\ref{lem:gh}. For (b), the $Z'_i$ operator for Alice corrects for the phase in $Z_jX(a)X(b)=(-1)^{a_j}X(a)Z(b+e_j)$.}
	\end{enumerate}    
\end{mdframed}
\end{center}
\begin{figure}[H]
\caption{Pauli Check}
\label{fig:pauli_check}
\end{figure}


\paragraph{Question types}
There are three types of questions: ``EPR questions'', ``Pauli questions'' and ``CTL-Pauli questions''. 
\begin{itemize}
\item \emph{EPR questions} range over the question set of the $2N$-qubit EPR test \tnote{this needs to be defined somewhere}. They are of the form $X'_i$ or $Z'_j$, for $i,j\in\{1,\ldots,2N\}$, or $(V'_i,W'_j)$ for $V,W\in\{X,Z\}$ and $i\neq j \in \{1,\ldots,2N\}$. \tnote{In fact there are additional question types involved, but these are the more relevant ones} When player A is sent an EPR question, it is additionally sent the identity of player B (i.e. which prover in $\mathcal{R}_r$ it corresponds to).
\item \emph{Pauli questions} range over the set of subsets 
$$\{W_1(w_1),W_2(w_2),W_3(w_3)\}\,\subseteq\,\{X(a),Z(b)\,|\; a,b\in\{0,1\}^N\}$$
 of cardinality at most $3$, and such that all (at most) three Pauli operators $W_i(w_i)$ in the set mutually commute, and all strings $w_i$ have Hamming weight at most $3$.
\item \emph{CTL-Pauli questions} range over the set $\{CX_i,CZ_j|i,j\in\{1,\ldots,N\}\}$.
\end{itemize}
Player A is always sent an EPR question and the identity of player B. Player B is always sent a pair consisting of an EPR question and a Pauli, or CTL-Pauli question. In the test as described in Figure~\ref{fig:pauli_check} Pauli questions consist of a single Pauli operator. In fact, the Pauli question is always embedded in a triple of commuting Pauli operators of weight at most $3$, where the other two operators are chosen uniformly among pairs that mutually commute and commute with the ``real'' question. In addition, even if the test only calls for a Pauli question, an EPR question is asked and chosen at random. (For a CTL-Pauli question of the form $CX_i$ (resp. $CZ_j$), the EPR question can be any question not involving the index $i$ (resp. $n+j$).) In all cases, only the player's answer to the ``real'' question is taken into account in the verifier's decision. 

\paragraph{The honest Pauli Check strategy}
A strategy $\mathcal{S} = (\rho,\{ M_P \})$ is an \textbf{honest Pauli Check strategy} if the following conditions are met. First, $\rho$ is a pure state $\ketbra{\psi}{\psi}$ on registers $\sC \sP_1 \cdots \sP_{\kappa(r)} \sR$, where $\sC = \sC_p \sC_{mip}$ is given to the $r$-th level verifier, $\sP_1 \cdots \sP_{\kappa(r)}$ is distributed among the provers in $\mathcal{P}_r$, and $\sR$ is a purifying register (parts of which may also be shared by the provers). For all provers $P \in \mathcal{P}_r$, the register $\sP_P$ is given to $P$.\footnote{Here we label the prover registers in two ways. To refer to prover $P$'s registers, we use $\sP_P$. If we are simply iterating over them, then we use an integer index such as $\sP_i$.}  For each non-ancillary prover $P \in \mathcal{R}_r$, the register $\sP_P$ includes two registers $\sB_P' \sB_P$, where $\sB_P'$ consists of $2N$ qubits and $\sB_P$ consists of $N$ qubits. The register $\sP_{PA}$ (corresponding to ancillary prover $PA$) includes registers $\{ \sA_P' \}_{P \in \mathcal{R}_r}$, where $\sA_P'$ consists of $2N$ qubits.
\hnote{At some point we should make a picture of all the provers with all the registers.}

The state $\ket{\psi}$ has the following form:
\begin{equation}
	\ket{\psi} = \frac{1}{\sqrt{\dim \sC_p}} \sum_{\substack{d \in \set{0,1} \\ t \in \set{0,\ldots,N} \\ P \in \mathcal{R}_r}} \ket{d,t,P}_{\sC_p} \otimes \ket{\psi_{d,t,P}}_{\sC_{mip} \sP \sR}
	\label{eq:honest-psi}
\end{equation}
where 
\[
	\ket{\psi_{1,0,PV}}_{\sC_{mip} \sP \sR} = \ket{\psi_{0,0,PV}}_{\sC_{mip} \sP \sR} = \Paren{ \bigotimes_{P \in \mathcal{R}_r} \ket{\Phi}_{\sA_P' \sB_P'}} \otimes \ket{\theta}_{\sC_{mip} \sB_{PV} \cdots \sB_{PP_{\kappa(r-1)}} \sR}
\]
for some state $\ket{\theta}$. Here, the state $\ket{\Phi}_{\sA_P' \sB_P'}$ is a tensor product of $2N$ EPR pairs, shared between $\sA_P'$ and $\sB_P'$. 
%We identify the register $\sP$ with a tensor product of registers $\sA_P' \sB_P' \sB_P$ for each $P \in \mathcal{R}_r$. Each $\sB_P$ register is isomorphic to $(\C^2)^{\otimes N}$. Each prover $P \in \mathcal{R}_r$ gets registers $\sB_P' \sB_P$. Prover $PA$ gets the registers $\{ \sA_P' \}$.

We define the rest of the states inductively. For $t > 0$ and $P \in \mathcal{R}_r$, define
\begin{align}
	\ket{\psi_{0,t,P}} = CZ_t \ket{\psi_{0,t-1,P}} \\
	\ket{\psi_{1,t,P}} = CX_t CZ_t \ket{\psi_{1,t-1,P}}
\end{align}
where $CZ_t$ (resp. $CX_t$) is a controlled-$Z$ (resp. controlled-$X$) gate whose control qubit is the $\sB_P'$ part of the $t$-th EPR pair (resp. $(N+t)$-th EPR pair) of $\ket{\Phi}_{\sA_P' \sB_P'}$, and whose target qubit is the $t$-th qubit of $\sB_P$. 

%The players share a state of the form~\eqref{eq:honest-psi}, where $\ket{\psi}_{\reg{BR}}$ is arbitrary and $\{X_i,Z_j:\, i,j\in\{1,\ldots,N\}\}$ are observables on $\mathcal{H}_\reg{B}$ that satisfy the Pauli relations. For $a,b\in \{0,1\}^N$ and $t\in\{0,\ldots,n\}$ let $X(a_{\leq t}) = X_t^{a_t}\cdots X_1^{a_1}$ and $Z(b_{\leq t}) = Z_t^{b_t}\cdots Z_1^{b_1}$. We also write $X(a)$ and $Z(b)$ for $X(a_{\leq N})$ and $Z(b_{\leq N})$ respectively. 

This finishes the specification of the state $\rho$. The next part of the specification is the measurement operators of the strategy. \hnote{Fill in here...}

%Player A applies the honest strategy for the EPR test, using the $2N$-qubit register $\reg{A}'$. On EPR questions Player B applies the  honest strategy for the EPR test, using the $2N$-qubit register $\reg{B}'$. On Pauli questions, player B uses the family of observables $X(a),Z(b)$ on $\reg{B}$ to determine his $3$-bit answer. On a CTL-Pauli question of the form $CX_i$ (resp $CZ_j$), the observable is controlled on the $i$-th qubit (resp. $N+j$-th qubit) of register $\reg{B}'$. 

\paragraph{Guarantees}


%The following lemma states completeness of the check. 

%
%\begin{lemma}[Completeness of the Pauli check]
%Let $\ket{\psi}_{\reg{BR}} \in \cH_\reg{B} \otimes \cH_\reg{R}$ be a state, such that $\reg{B}$ is an $N$-qubit quantum register. Let $X(a)$ and $Z(b)$, for $a,b\in\{0,1\}^N$, be Pauli operators on $\reg{B}$. Let $\reg{A}'$, $\reg{B}'$ be $2N$-qubit registers, and 
%\begin{equation}\label{eq:honest-psi}\ket{\Psi}_{\reg{C}_{p} \reg{A'B'BR}} \,=\, \frac{1}{\sqrt{2(N+1)}} \sum_{\substack{d\in\{0,1\} \\ t\in\{0,\ldots,N\}}} \ket{d,t}_{\reg{C}_{p}}  \frac{1}{2^N} \sum_{a,b \in \{0,1\}^N} \ket{a,b}_{\reg{A}'} \ket{a,b}_{\reg{B}'} \big(X(d\cdot a_{\leq t}) Z(b_{\leq t})\otimes \Id_R\big)\ket{\psi}_\reg{BR}\;.
%\end{equation}
%Then there exists a strategy for players A and B sharing state $\ket{\Psi}_{\reg{C}_{p} \reg{A'B'BR}}$ that succeeds with probability $1$ in the Pauli check.  
%\end{lemma}
%
%The next lemma states soundness of the check.
%
%\begin{lemma}[Soundness of the Pauli check (OLD)]
%\label{lem:pauli_check_soundness}
%Suppose players A and B sharing state $\ket{\psi}_{\reg{C}_p\reg{A'B'BR}}$ succeed with probability at least $1-\eps$ in \textsc{Pauli Check}. Here $\reg{C}_p$ is part of the register sent to the verifier, $\reg{A'}$ and $\reg{B'B}$ are held by $A$ and $B$ respectively, and $\reg{R}$ is arbitrary. 
%
%Then there exists a $\delta = \poly(n,\eps)$ and local isometries $V_A: \cH_A \to \cH_A \otimes \cH_{A'}$, $V_B:\cH_{B}\to  (\C^2)^{\otimes N} \otimes \cH_{B'} \otimes \cH_{B''}$ such that   for all Pauli questions $(W_1(w_1),W_2(w_2),W_3(w_3))$ and all triples of answers $(a_1,a_2,a_3)$, if $W^{abc}$ is the associated POVM for player B then 
%$$ \sum_{a,b,c\in\{\pm1\}}\big\| \Id_{\reg{CAR}}\otimes  V_B W^{abc} \ket{\psi}_{\reg{CABR}} -  \Id_{\reg{CAR}}\otimes\sigma_{W_1}(w_1)^{a_1} \sigma_{W_2}(w_2)^{a_2}\sigma_{W_3}(w_3)^{a_3}V_B \ket{\psi}_{\reg{CABR}} \big\|^2 \,=\,O(\delta)\;.$$
%Moreover, \tnote{Do we need this part? Seems like the only thing we want is the Pauli operators, we don't care about the form of the state?}
%\begin{equation}\label{eq:hist-epr-state}
%V_A \otimes V_B \otimes \Id_{CR} \ket{\psi}_\reg{CABR} \approx_\delta \frac{1}{\sqrt{2(N+1)}} \sum_{d\in\{0,1\},t\in\{0,\ldots,N\}} \ket{d,t}_{C}  \frac{1}{2^N} \sum_{a,b \in \{0,1\}^N} \ket{a,b}_{A'} \ket{a,b}_{B'} \big(\Id_A \otimes X(d\cdot a_{\leq t}) Z(b_{\leq t})\otimes \Id_R\big)\ket{\psi}_\reg{ABR}\;.
%\end{equation}
%
%\end{lemma}

\begin{lemma}[Completeness and soundness of the Pauli Check]
\label{lem:pauli_check}
\leavevmode
\begin{enumerate}
	\item (\textbf{Completeness}) Any honest Pauli Check strategy passes the Pauli Check subroutine with probability $1$.
	
	\item (\textbf{Soundness}) Any strategy $\mathcal{S}$ that passes the Pauli Check with probability at least $1 - \eps$ is $\delta$-isometric to an honest Pauli Check strategy for some $\delta = \poly(N,\eps)$.
\end{enumerate}
\end{lemma}



\tnote{The next lemma will be part of the proof of the soundness analysis. For now, ignore it}

\begin{lemma}\label{lem:gh}
Let $\{X_i,Z_j:\, i,j\in\{1,\ldots,n\}\}$ be observables on $\mathcal{H}_B$, and $\ket{\psi}_{BR}$ a state on $\mathcal{H}_B\otimes \cH_R$ such that  on average over $a,b\in\{0,1\}^n$ and $i,j\in\{1,\ldots,n\}$,
\begin{align}
\Id_A \otimes X_i X(a) Z(b)\otimes \Id_R \ket{\psi}& \approx_\delta \Id_A \otimes X(a+e_i)Z(b) \otimes \Id_R \ket{\psi}_{ABR}\label{eq:x-com}\\
\Id_A \otimes Z_i X(a) Z(b)\otimes \Id_R \ket{\psi}& \approx_\delta \Id_A \otimes (-1)^{a_i} X(a)Z(b+e_i) \otimes \Id_R \ket{\psi}_{ABR}\;,\label{eq:z-com}
\end{align}
for some error $\delta$. Then there is an isometry $V:\cH_B \to (\C^2)^{\otimes n} \otimes \cH_{B''}$ such that 
$$ \Es{i} \big\|  VX_i \ket{\psi} -  \sigma_X(e_i) V\ket{\psi} \big\| + \Es{j} \big\| VZ_j \ket{\psi} - \sigma_Z(e_j) V\ket{\psi} \big\| \,=\,O(\delta)\;,$$
where $\sigma_X(e_i)$ (resp. $\sigma_Z(e_j)$) acts on the $i$-th (resp. $j$-th) copy of $\C^2$ in the range of $V$. 
\end{lemma}

\begin{proof}
The relations~\eqref{eq:x-com} and~\eqref{eq:z-com} are sufficient to verify that $X(a)Z(b)$ is an approximate representation of the Pauli group, and apply the Gowers-Hatami theorem.
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%		PROPAGATION CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Propagation check}
\label{sec:prop_check}

\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,r,G,V,M)$
	\begin{enumerate}
		\item (\textsc{ClockMeasurement}) Select a uniformly random integer $t\in\{1,\ldots, \tau(N)\}$, where $N = 2^n$. Write on the measurement specification tape a description for the circuit $C_M$ that implements the following measurement, which is a tensor product of a two-outcome POVM $F$ acting on clock register $\reg{C}_p$ and a three outcome POVM $\Pi_t$ acting on clock register $\reg{C}_{mip}$: 
\[
	\{F^0 = \ketbra{0}{0}, F^1 = \Id - F^0 \}\;,
\]
\[
	\{ 	\Pi^0 = \ketbra{+_t}{+_t}, 
	\Pi^1 = \ketbra{-_t}{-_t}, 
	\Pi^2 = \Id - \Pi^0 - \Pi^1 \}\;.
\]	
Let $(p,s) \in \{0,1\} \times \{0,1,2\}$ denote the result of the six-outcome measurement $F \otimes \Pi_t$.

	\item (\textsc{GenQuestions}) Execute the GTM $G$ to compute $g = G(N,r-1,t)$. 
	\begin{itemize}
		\item If $g$ is a Toffoli gate or doubled Hadamard gate, then generate questions according to \textsc{Toffoli Check} or \textsc{Hadamard Check}, respectively. 
		\item If $g$ is a prover question to prover $P$, then set $q_P = \star$. %\tnote{a nice convention I used in another paper, is to use ``question'' for any individual question to a prover, and ``query'' for a complete tuple of questions to all provers. So, here it would be ``question''}	
	\end{itemize}
%	If $g$ is a verifier gate, compute questions as in the Verifier Gate Check. If $g$ is a prover query, compute questions as in the Prover Gate Check.
		\item (\textsc{CheckAnswers}) If $p \neq 0$, accept. If $s = 2$, then accept. Otherwise:
		\begin{itemize}
			\item If $g$ is a Toffoli gate or doubled Hadamard gate, check the answers according to \textsc{Toffoli Check} or \textsc{Hamadard Check}, respectively. 
			\item If $g$ is a prover question to prover $P$, then accept only if $a_P = s$. 
		\end{itemize}
	\end{enumerate}    
\end{mdframed}

\end{center}
\begin{figure}[H]
\caption{Propagation Check}
\label{fig:prop_check}
\end{figure}

The procedures  \textsc{Toffoli Check} and \textsc{Hadamard Check} are taken from~\cite{ji2016compression}. For completeness, we include a description. For simplicity we give an ``operational'' description of the procedures, with the understanding that each should be broken down into three phases, as described in Figure~\ref{fig:check_structure}.

A Toffoli or doubled Hadamard gate $g$ returned by the GTM $G$ always comes together with labels for a set of qubits on which the gate acts on. These qubits refer to qubits on which the $(r-1)$-level verifier $UEVC_{N,r-1}$ acts on. In the protocol executed by the $r$-level verifier $UEVC_{n,r}$, the qubits are distributed among the provers. In the description of the tests, we refer to the ``prover holding qubit $u$'' to specify the appropriate prover. For example, if $u$ is a qubit in $\reg{V}_{r-1,in}$ then the prover is $PV$; if it is a qubit in $\reg{M}_{r-1,j}$ then the prover is $PP_j$, etc. 


\vspace{10pt}
\begin{center}
\begin{mdframed}
    \textbf{Toffoli Check} \\
	Input: $(1^n,w,r,s,g)$, where $g$ is a Toffoli gate acting on qubits $u_1,u_2,u_3$ of $UEVC_{N,r-1}$, and $s \in \{0,1\}$. 
	\begin{enumerate}
		\item Sample $\alpha \in \{0,1\}$ uniformly at random, and accept if $\alpha = 1$. Otherwise, continue.
		\item Send the questions $Z_{u_1}$, $Z_{u_2}$, and $X_{u_3}$ to the prover holding qubit $u_1$, $u_2$, and $u_3$ respectively. Let $a_1,a_2,a_3 \in \{0,1\}$ be the three answer bits. 
		\item Reject if $a_1 = a_2 = 1 \wedge s \oplus a_3 = 1$, or $a_1 a_2 = 0 \wedge s = 1$.
		\item Accept otherwise.
	\end{enumerate}    
    \vspace{10pt}
\textbf{Hadamard Check} \\
	Input: $(1^n,w,r,s,g)$, where $g$ is a double Hadamard gate acting on qubits $u_1,u_2$ of $UEVC_{N,r-1}$, and $s \in \{0,1\}$.

	\begin{enumerate}
		\item Sample $\alpha \in \{0,1\}$ uniformly at random.
		\item If $\alpha = 0$, send the questions  $X_{u_1} X_{u_2}$ and $Z_{u_1} Z_{u_2}$ to the prover holding qubits $u_1$ and $u_2$.\footnote{We assume without loss of generality that the two qubits of a doubled Hadamard gate are held by the same prover.} Let $a_1,a_2$ be the two answer bits. Reject if $s \oplus a_1 = s \oplus a_2 = 1$, accept otherwise.
		\item If $\alpha = 1$, send the questions $X_{u_1} Z_{u_2}$ and $Z_{u_1} X_{u_2}$ to the prover holding qubits $u_1$ and $u_2$. Let $a_1,a_2$ be the two answer bits. Reject if $s \oplus a_1 = s \oplus a_2 = 1$ and accept otherwise.
	\end{enumerate}    
\end{mdframed}

\end{center}
\begin{figure}[H]
\caption{Toffoli and Hadamard Checks}
\label{fig:toffoli_hadamard_check}
\end{figure}

%
%\vspace{10pt}
%\begin{center}
%\begin{mdframed}
%	Input $(1^n,w,r,s,g)$ \\
%	Promise: $g$ is a doubled Hadamard gate acting on qubits $u_1,u_2$ of $UEVC_{N,r-1}$, and $s \in \{0,1\}$.
%    
%	\begin{enumerate}
%		\item Sample $\alpha \in \{0,1\}$ uniformly at random.
%		\item If $\alpha = 0$, ask the appropriate prover (depending on who is supposed to hold $u_1,u_2$) to measure the two-qubit observables $X_{u_1} X_{u_2}$ and $Z_{u_1} Z_{u_2}$ simultaneously.\footnote{We assume without loss of generality that the two qubits of a doubled Hadamard gate are held by the same prover.} Let $a_1,a_2$ be the two answer bits. Reject if $s \oplus a_1 = s \oplus a_2 = 1$, accept otherwise.
%		\item If $\alpha = 1$, ask the appropriate prover to measure the two-qubit observables $X_{u_1} Z_{u_2}$ and $Z_{u_1} X_{u_2}$ simultaneously. Let $a_1,a_2$ be the two answer bits. Reject if $s \oplus a_1 = s \oplus a_2 = 1$ and accept otherwise.
%	\end{enumerate}    
%\end{mdframed}
%
%\end{center}
%\begin{figure}[H]
%\caption{Hadamard Check}
%\label{fig:hadamard_check}
%\end{figure}

\begin{lemma}[Hadamard and Toffoli Check~\cite{ji2016compression}]
\label{lem:ver_gate_check}
	Let $\mathcal{S}$ be an honest Pauli strategy with $\rho_{\sC_{mip} \sP}$ as the shared state in \textsc{Hadamard Check} (resp. \textsc{Toffoli Check}). Let $U$ denote a doubled Hadamard gate (resp. Toffoli gate). Then the \textsc{Hadamard Check} (resp. \textsc{Toffoli Check}) rejects with probability \tnote{Do we want to use $\Tr_\rho$ as notation? The format for this soundness guarantee is different from the format in Pauli check. Are we going to use this? I am less used to it, but I'm fine either way.} \hnote{I think this is a clean format... the Propagation, Input and Output Check analyses all use the $\Tr_\rho$ format for the soundness guarantees.}
	
	\[
		\frac{1}{4} \Tr_{\rho} \left[ \Id - J_t \otimes U \right ]
	\]
	where $J_t$ denotes the following unitary acting on $\sC_{mip}$:
	\[
		J_t = \Id - 2\ketbra{-_t}{-_t}
	\]
	where $\ket{-_t} = \frac{1}{\sqrt{2}} \left( \ket{t} - \ket{t+1} \right)$.
\end{lemma}

\paragraph{The high level}  At a high level, this test  proceeds as follows. The $r$-th level verifier samples a random time $t \in \{1,\ldots,\tau(N)\}$, and computes the $t$-th gate $g_t$ of $UEVC_{N,r-1}$ using the GTM $G = G_{UEVC}$. Most of the time, the gate $g_t$ is a (doubled) Hadamard or Toffoli gate that is computed by the $(r-1)$-th level verifier $UEVC_{N,r-1}$. To check the propagation of such a gate, the $r$-level verifier executes the corresponding Hamadard or Toffoli Check (see Figure~\ref{fig:toffoli_hadamard_check}) to generate the corresponding questions. %If the gate $g_t$ does not act on any of the $\{ \sM_i\}$ register of $UEVC_{N,r-1}$, then the Hadamard/Toffoli check questions are sent to prover $PV$. If $g_t$ acts partially on the $\sM_i$ register, then the questions are partially sent to $PV$, and partially sent to $PP_i$. If $g_t$ acts fully on $\sM_i$, then all the questions are sent to $PP_i$.
In some cases the gate $g_t$ is not be a gate, but rather it represents the $i$-th prover's unitary. In that case, prover $i$ is sent the question $\star$.  

Any prover who was not explicitly sent a question is sent a null question, denoted by $\bot$.

\paragraph{Question types} There are two types of questions in this test: Pauli operations, and a prover reflection question $\star$.


\paragraph{Honest Propagation Check strategy} For all $0 \leq t \leq \tau(N)$, let $g_t = G(N,r-1,t)$. An honest Pauli strategy $\mathcal{S}$ is an honest Propagation Check strategy if the shared state $\ket{\psi}_{\sC_p \sC_{mip} \sP \sR}$, when projected onto the space where the $\sC_p$ register is all zeroes, is a history state of the computation $g_1g_2\cdots g_{\tau(N)}$. In other words, it has the following form:
\[
	\left( \ketbra{0}{0}_{\sC_p} \right) \, \ket{\psi}_{\sC_p \sC_{mip} \sP \sR} = \ket{0}_{\sC_p} \otimes \frac{1}{\poly(N)} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC_{mip}} \otimes \ket{\psi_t}_{\sP \sR}
\]
where for all $t$, the state $\ket{\psi_t}_{\sP \sR}$ is defined to be $g_t \ket{\psi_{t-1}}_{\sP \sR}$ with $g_t$ being either a doubled Hadamard, a Toffoli, or a prover reflection acting on the correct registers. The state $\ket{\psi_0}$ is arbitrary. The $r$'th level verifier holds register $\sC = \sC_p \sC_{mip}$ and the provers in $\mathcal{P}_r$ jointly hold $\sP$. The register $\sP$ itself is decomposed into a tensor product of registers $\bigotimes_P \sP_P$. 

Since $\mathcal{S}$ is an honest Pauli Check strategy, the register $\sP_P$ corresponding to a non-ancillary prover $P \in \mathcal{R}_r$ has additional structure: it includes two registers $\sB_P' \sB_P$. We will further refine the naming of these registers.

The register $\sB_{PV}$ (belonging to prover $PV$) consists of $N$ qubits, and is divided into three registers $\sC_{r-1}, \sV_{r-1,in}, \sV_{r-1,work}$, each of size $N/3$ qubits \hnote{Subject to change...}. 
For all $i$, the $\sB_{PP_i}$ register also has the name $\sM_{r-1,i}$. From this point on, we will not refer to the $\sB_P$ registers and use these new names.

% (all held by prover $PV$) and registers $\{ \sM_{r-1,i} \}$ (held by provers $\{ PP_i \}$). We can assume that the register $\sP$ has this tensor product structure because the strategy is an honest Pauli strategy. The register $\sR$ is some purifying register (part of which may be shared by the verifier and provers). 

\begin{lemma}	
\label{lem:prop_check}
\begin{enumerate}
\item (\textbf{Completeness}) An honest Propagation strategy passes the $\textsc{Propagation Check}$ subprotocol with probability $1$. 
\item (\textbf{Soundness}) All honest Pauli strategies $\mathcal{S}$ that pass the $\textsc{Propagation Check}$ subprotocol with probability at least $1 - \eps$ are $\poly(N,\eps)$-close to an honest Propagation Check strategy. \tnote{do you have a good way to write $\poly(N,\eps)$? I know I used it too. But of course $N^2 = \poly(N,\eps)$, which is not super helpful. I can only think of $\poly(N)\cdot \poly(\eps)$, which is kind of ugly.} \hnote{Maybe in the end, we can put $O(N^\alpha \eps^\beta)$ once we figure out $\alpha,\beta$, but for now we can just keep it $\poly(N,\eps)$ to make things less ugly.}
\end{enumerate}
\end{lemma}
\begin{proof}
	The completeness statement of the Theorem is straightforward. We now argue about the soundness statement. This analysis largely follows that of~\cite{ji2016compression}. 
	
	Let $\ket{\psi}_{\sC_p \sC_{mip} \sP \sR}$ denote the shared state in the honest Pauli strategy $\mathcal{S}$, and let $\rho = \ketbra{\psi}{\psi}$. By assumption, the rejection probability with $\rho$ as the shared state is at most $\eps$.
	
	Let $\Pi = \ketbra{0}{0}_{\sC_p}$, the projection onto the all zeroes state of $\sC_p$. Since $\mathcal{S}$ is an honest Pauli strategy, we have that $\Tr_\rho (\Pi) \geq 1/\poly(N)$. Let 
	\[
		\rho_0 = \frac{\Pi \rho \Pi}{\Tr_\rho(\Pi)} = \frac{\Pi \ketbra{\psi}{\psi} \Pi}{\bra{\psi} \Pi \ket{\psi}}.
	\]
	The probability that the \textsc{Propagation Check} subroutine rejects when the shared state is $\rho_0$ instead of $\rho$ is at most $\eps' = \poly(N) \eps$. 
	
	Suppose now that the shared state in the \textsc{Propagation Check} is $\rho_0$. We now give an expression for the rejection probability. For any $t \in \{0,1,\ldots,\tau(N)\}$, let $r_t$ denote the rejection probability conditioned on the verifier choosing $t$. If $g_t$ corresponds to a doubled Hadamard gate or a Toffoli gate, by Lemma~\ref{lem:ver_gate_check} the rejection probability is 
	\[
		r_t = \frac{1}{4} \Tr_{\rho_0} \left ( \Id - J_t \otimes g_t \right ).
	\]
	If $g_t$ corresponds to a prover question to prover $PP_j$, then the rejection probability is equal to
	\[
		r_t = \frac{1}{2} \Tr_{\rho_0} \left ( \Id - J_t \otimes g_t \right ).
	\]
	where we define $g_t$ to prover $PP_j$'s reflection upon the question $\star$. The overall rejection probability satisfies
	\[
		\eps' \geq \E_t r_t  \geq \frac{1}{4} \E_t \Tr_{\rho_0} \left ( \Id - J_t \otimes g_t \right ).
	\]	
	In other words, we have
	\[
		\E_t \Tr_{\rho'} \left ( \ketbra{-_t}{-_t} \right ) \leq \eps'
	\]
	where we define
	\[
		\rho' = Q^\dagger \rho_0 Q, \qquad Q = \sum_t \ketbra{t}{t}_{\sC_{mip}} \otimes g_t \cdots g_1.
	\]
%	Observe that $\E_t  \left [ \ketbra{-_t}{-_t} \right ] =  \cL(L)$ where $\cL(L)$ is the Laplacian \tnote{do we need to use a fancy word, especially if we don't define it? Will there be other things than Laplacians of line graphs?} of the line graph $L$ of length $\tau(N)+ 1$. 
Thus we have
	\[
		\Tr_{\rho_0} \E_t  \left ( Q\ketbra{-_t}{-_t}Q^\dagger  \right) \leq \eps'.
	\]
	For reasons that will become clear soon, we will let $H_{prop}$ denote the operator $\E_t  \left ( Q\ketbra{-_t}{-_t}Q^\dagger  \right)$. Notice that $H_{prop}$ is positive semidefinite, has smallest eigenvalue $0$ and the second smallest eigenvalue is at least $1/\poly(N)$. Using Lemma~\ref{lem:closeness_to_groundspace}, we have that $\rho_0$ is $\poly(N,\eps)$-close to a pure state $\ketbra{\theta}{\theta}$ satisfying $H_{prop} \ket{\theta} = 0$. 
	
	Now notice that $H_{prop}$ is resembles the propagation term of the Feynman-Kitaev Hamiltonian that checks the propagation of the computation $g_1 g_2 \cdots g_{\tau(N)}$~\cite{kitaev2002classical}. Thus any state $\ket{\theta}$ in the kernel of $H_{prop}$ must be a history state $\ket{\theta}_{\sC_{mip} \sP \sR} = \frac{1}{\sqrt{\tau(N)+1}} \sum_t \ket{t}_{\sC_{mip}} \otimes \ket{\theta_t}_{\sP \sR}$ where $\ket{\theta_t} = g_t \ket{\theta_{t-1}}$.
	
	We can thus construct a new honest Pauli strategy $\mathcal{S}'$ where the prover operators are the same as in $\mathcal{S}$, and the shared state $\ket{\psi'}_{\sC \sP \sR}$ is such that $\Pi \ket{\psi'} = \ket{0}_{\sC_{mip}} \otimes \ket{\theta}$ (i.e. is a history state for the computation $g_1 g_2 \cdots g_{\tau(N)}$) and otherwise has the form~\eqref{eq:honest-psi}.\footnote{Such a state $\ket{\psi'}$ can be constructed by starting with $\ket{0}_{\sC_{mip}} \otimes \ket{\theta}$ and ``propagating'' the Pauli operators as needed by the Pauli Check.} We have that $\| \ket{\psi} - \ket{\psi'} \|^2 \leq \poly(N,\eps)$, so $\mathcal{S}'$ is $\poly(N,\eps)$-close to $\mathcal{S}$, and furthermore $\mathcal{S}'$ is an honest Propagation Check strategy. This concludes the proof. \hnote{We will need to write what it means for two strategies to be close.}
%	The propagation term has spectral gap $1/\poly(N)$ and its zero eigenspace is exactly the space of history states of the aforementioned computation.
	
	%This, combined with Lemma~\ref{lem:closeness_to_groundspace}, implies that $\rho_0$ is $\poly(N,\eps)$-close to a history state of the computation $g_1g_2\cdots g_{\tau(N)}$.%\tnote{should the last implication refer to a theorem?}
	
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%		INPUT CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Input check}
\label{sec:input_check}


\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,r,G,V,M)$
    %\hnote{The input register to $UEVC_{N,r}$ is $\alpha N$-bits long.}
    
	\begin{enumerate}
		\item (\textsc{ClockMeasurement}) Write into the measurement specification tape the circuit $C_M$ that measures $\sC_p \sC_{mip}$ in the computational basis, with the outcome being $(d,t_p,t_{mip})$.
		\item (\textsc{GenQuestions}) If $(d,t_p,t_{mip})$ is not $(0,0,0)$, then continue to the \textsc{CheckAnswers} phase. Otherwise, pick a random qubit $j \in \supp(\sV_{r-1} \setminus \{\sC_{r-1} \})$. 
		\begin{itemize}
			\item If $j \in \supp(\sM_{r-1,i})$, set $q_{P,i} = Z_j$.
			\item If $j \notin \supp(\sM_{r-1,i})$, set $q_V = Z_j$.
		\end{itemize}
		
		\item (\textsc{CheckAnswers}) 
		\begin{itemize}
			\item If $(d,t_p,t_{mip})$ is not $(0,0,0)$, then accept. 
			\item If $j \notin \supp(\sV_{r-1,in} \setminus \sM_{r-1})$ and $a_V = 0$, then accept. 
			\item If $j \in \supp(\sV_{r-1,in})$ and $a_V$ is equal to the $j$'th bit of the string that is $(G,V,M)$ padded by $0$, then accept. 
			\item If $j \in \supp(\sM_{r-1,i})$ and $a_{P,i} = 0$, then accept.
			\item Otherwise, reject.
		\end{itemize}
	\end{enumerate}    
\end{mdframed}
\end{center}
\begin{figure}[H]
\caption{Input Check}
\label{fig:input_check}
\end{figure}

\paragraph{The high level} First, we will assume that the strategy is an honest \textsc{Propagation Check} strategy (and thus an honest Pauli strategy), meaning that the provers will share a history state of the protocol between the $(r-1)$-th level verifier $UEVC_{N,r-1}$ and a number of provers. The \textsc{Input Check} subroutine will check that in the first snapshot of the history state, the prover $PV$ (which is supposed to play the role of $UEVC_{N,r-1}$) has the $\sV_{r-1,in}$ register initialized to the input $(G,V,M)$, and $\sV_{r-1,work} $ set to zeroes. Furthermore, the subroutine will check that the $PP_i$ prover has the message register $\sM_{r-1,i}$ set to all zeroes.

\paragraph{Honest Input Check strategy}
An honest Propagation Check strategy $\mathcal{S}$ with shared state
\[
	\ket{\psi}_{\sC_{mip} \sC_p \sP \sR} = \frac{1}{\sqrt{\tau(N) + 1}} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC_{mip}} \otimes \ket{\psi_t}_{\sC_p \sP \sR}
\]
is an honest Input Check strategy if the initial state $\ket{\psi_0}_{\sP \sR}$ is such that the $\sV_{r-1} \setminus \sC_{r-1} = \sV_{r-1,in}\sV_{r-1,work} \sM_{r-1}$ registers are in the state $\ket{G,V,M,0}$. In other words, the $(r-1)$-th level verifier is properly initialized.

%For all $0 \leq t \leq \tau(N)$, let $g_t = G(N,r-1,t)$. A strategy $\mathcal{S}$ is an honest Propagation strategy if the Pauli operators are trusted and the shared state has the following form:
%where $\ket{\psi_t}_{\sP \sE} = g_t \ket{\psi_{t-1}}_{\sP \sE}$ with $g_t$ being either a doubled Hadamard, a Toffoli, or a prover reflection. The state $\ket{\psi_0}$ is arbitrary.



\begin{lemma}	
\label{lem:input_check}
\begin{enumerate}
	\item (\textbf{Completeness}) An honest Input Check strategy passes the $\textsc{Input Check}$ subprotocol with probability $1$. 
	\item (\textbf{Soundness}) All honest Propagation Check strategies $\mathcal{S}$ that pass the $\textsc{Input Check}$ subprotocol with probability at least $1 - \eps$ are $\poly(N,\eps)$-close to the honest Input Check strategy.
\end{enumerate}
\end{lemma}
\begin{proof}
The completeness statement of the Theorem is straightforward. We now argue about the soundness statement.

Let $\ket{\psi}_{\sC_p \sC_{mip} \sP \sR}$ denote the shared state. Let $\rho = \ketbra{\psi}{\psi}$. Since the strategy $\mathcal{S}$ is an honest Propagation Check strategy (and therefore an honest Pauli Check strategy), we have that
\begin{enumerate}
	\item $\Tr_\rho \left ( \ketbra{0}{0}_{\sC_p} \right) \geq 1/\poly(N)$
	\item $	\left( \ketbra{0}{0}_{\sC_p} \right) \, \ket{\psi}_{\sC_p \sC_{mip} \sP \sR} = \frac{1}{\poly(N)} \sum_{t = 0}^{\tau(N)} \ket{0}_{\sC_p} \otimes \ket{t}_{\sC_{mip}} \otimes \ket{\psi_t}_{\sP \sR}$
\end{enumerate}
Let $\Pi = \ketbra{0,0}{0,0}_{\sC_p \sC_{mip}}$. These two items imply that $\Tr_\rho (\Pi) \geq 1/\poly(N)$. Let 
\[
	\rho_{00} = \frac{\Pi \rho \Pi}{\Tr_\rho (\Pi)} = \ketbra{0,0}{0,0}_{\sC} \otimes \ketbra{\psi_0}{\psi_0}_{\sP \sR}.
\]
The probability that \textsc{Input Check} rejects when the shared state is $\rho_{00}$ instead of $\rho$ is at most $\eps' = \poly(N) \eps$. 

Suppose now that the shared state in \textsc{Input Check} is $\rho_{00}$. Let $\sA = \sV_{r-1} \setminus \sC_{r-1}$ (i.e. all the qubits of $\sV_{r-1}$ except those in $\sC_{r-1}$) and $\sB = \sP \sR \setminus \sA$ (i.e. all the qubits of $\sP \sR$ except those in $\sA$). Consider an ordering of the qubits in the registers $\sA$  so that $\sV_{r-1,in}$ goes first, followed by the rest of the registers. Let $x$ denote the string of length $|\sV_{r-1,in}|$ that is $(G,V,M)$ padded with zeroes. The probability of rejection is then
	\begin{equation}
		\Tr_{\rho_{00}} ( H_{init} ) \leq \eps'
		\label{eq:init}
	\end{equation}
	where we define 
	\[
		H_{init} = \frac{1}{\left | \sA \right|} \left ( \sum_{i \in \sV_{r-1,in}} \ketbra{\overline{x}_i}{\overline{x}_i}_i +  \sum_{i \notin \sV_{r-1,in}} \ketbra{1}{1}_i \right)
	\] 
	where the first sum is over all the qubits in $\sV_{r-1,in}$ and the second sum is over all qubits in $\sA \setminus \sV_{r-1,in}$. We use $\overline{x}_i$ to denote the complement of the bit $x_i$. The subscripts on a projector (such as $\ketbra{1}{1}_i$) indicates which qubit it acts on. We use $|\sA|$ to denote the number of qubits in $\sA$. 
	
	Notice that $H_{init}$ resembles the term of the Feynman-Kitaev Hamiltonian that checks if the history state is initialized correctly. The unique eigenvector of eigenvalue $0$ of $H_{init}$ (on the register $\sA$) is the state $\ket{G,V,M,0}$. The inequality in~\eqref{eq:init} and Lemma~\ref{lem:closeness_to_groundspace} implies that
	\[
		\Norm{ \ket{\psi_0}_{\sP \sR} - \ket{G,V,M,0}_{\sA} \otimes \ket{\theta}_{\sB} }^2 \leq \poly(N,\eps)
	\]
	for some state $\ket{\theta}_{\sB}$.
	
	Thus we can construct a new honest Propagation strategy $\mathcal{S}'$ where the prover operators are the same as in $\mathcal{S}$, and the shared state $\ket{\psi'}_{\sC \sP \sR}$ is such that $\Pi \ket{\psi'} = \ket{0,0}_{\sC} \otimes \ket{G,V,M,0}_{\sA} \otimes \ket{\theta}_{\sB}$, and otherwise has the form of an honest Propagation strategy. We have that $\| \ket{\psi} - \ket{\psi'} \|^2 \leq \poly(N,\eps)$, so therefore $\mathcal{S}'$ is $\poly(N,\eps)$-close to $\mathcal{S}$, and furthermore $\mathcal{S}'$ is an honest Input Check strategy. This concludes the proof.
	
%	$\Big( \rho_{00} \Big)_{\sV_{r-1} \setminus \{ \sC_{r-1} \}}$ is $\poly(N) \eps'$-close to $\ketbra{G,V,M,0}{G,V,M,0}$. This finishes the proof.

	
%Let $\Big( \rho_0 \Big)_{\sV_{r-1} \setminus \{ \sC_{r-1} \}}$ denote the reduced density matrix of $\rho_{00}$ on the registers $\sV_{r-1} \setminus \{ \sC_{r-1} \}$. 

\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%		OUTPUT CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Output check}
\label{sec:output_check}


\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,r,G,V,M)$
	\begin{enumerate}
		\item (\textsc{ClockMeasurement}) Write into the measurement specification tape the circuit $C_M$ that measures $\sC_p \sC_{mip}$ in the computational basis, with the outcome being $(d,t_p,t_{mip})$.
		
		\item (\textsc{GenQuestions}) If $(d,t_p,t_{mip})$ is not $(0,0,\tau(N))$, then continue to the \textsc{CheckAnswers} phase. Set $q_V = \supp(\sV_{r-1,work})_1$ (i.e. the first qubit of $\sV_{r-1,work}$).
		\item (\textsc{CheckAnswers}) If $(d,t_p,t_{mip})$ is not $(0,0,\tau(N))$, then accept. If $a_V = 1$, then accept. Otherwise, reject.
	\end{enumerate}    
\end{mdframed}
\end{center}
\begin{figure}[H]
\caption{Output Check}
\label{fig:output_check}
\end{figure}


\paragraph{The high level} The \textsc{Output Check} checks that the last snapshot $\ket{\psi_{\tau(N)}}$ of the history state has the output qubit (the first qubit of the workspace register) set to $1$ (or close to it). To do so, the subroutine will command the prover $PV$ to measure  qubit $\supp(\sV_{r-1,work})_1$ in the computation basis. 

% post-selects on the clock register $\sR$ in reading the last time $\tau(N)$ of the circuit, and the verifier will ask prover $1$ to measure its first qubit in the computational basis, which should correspond to the output bit of the history state. 

%\paragraph{Honest strategy} 

\begin{lemma}	
\label{lem:output_check}
Let $\omega_{N,r-1}$ denote the maximum acceptance probability of the protocol that is executed by the verifier $UEVC_{N,r-1}$ on input $(G_{UEVC},V_{NV},M)$. 
\begin{enumerate}
	\item (\textbf{Completeness}) If $\omega_{N,r-1} = 1$, then there exists an honest Input Check strategy that passes the Output Check protocol with probability $1$.
	
	\item (\textbf{Soundness}) All honest Input Check strategies pass the Output Chek subprotocol with probability at most 
\[
	1 - \frac{1 - \omega_{N,r-1}}{\poly(N)}.
\] 
\end{enumerate}
\end{lemma}
\begin{proof}
The Completeness part of the Theorem statement follows from the fact that one can construct an honest Input Check strategy that corresponds to provers using the perfect strategy that achieves $\omega_{N,r-1} = 1$.

We now argue the Soundness part of the Theorem statement. Let $\ket{\psi}_{\sC_p \sC_{mip} \sP \sR}$ denote the shared state. Let the rejection probability with this shared state be $\eps$. Since the strategy is an honest Input Check strategy, the shared state (when conditioned on $\sC_p$ register being zero) is a history state of the protocol executed by the verifier $UEVC_{N,r-1}$ with a number of provers,
\[
\frac{1}{\sqrt{\tau(N) + 1}} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC_{mip}} \otimes \ket{\psi_t}_{\sP \sR}
\]
with the initial snapshot state $\ket{\psi_0}$ being properly initialized to $\ket{G,V,M,0}$ in the $\sV_{r-1} \setminus \{ \sC_{r-1} \}$ registers. Note that the probability of rejection in the protocol described by the history state is 
\[
	\Tr \left ( \ketbra{0}{0}_{out} \, \ketbra{\psi_{\tau(N)}}{\psi_{\tau(N)}} \right) \geq 1 - \omega_{N,r-1}.
\]
where $\ketbra{0}{0}_{out}$ is the projector onto the state $\ket{0}$ of the first qubit of the workspace register.

Let $\rho = \ketbra{\psi}{\psi}$. Let $\Pi = \ketbra{0}{0}_{\sC_p} \otimes \ketbra{\tau(N)}{\tau(N)}_{\sC_{mip}}$. We have that $\Tr_\rho (\Pi) \geq 1/\poly(N)$. Let
\[
\rho_0 = \frac{\Pi \rho \Pi}{\Tr_\rho (\Pi)} = \ketbra{0,\tau(N)}{0,\tau(N)}_{\sC} \otimes \ketbra{\psi_{\tau(N)}}{\psi_{\tau(N)}}.
\]
The probability that \textsc{Output Check} rejects when the shared state $\rho_0$ is at most $\eps' = \poly(N) \eps$. The rejection probability when the shared state is $\rho_0$ can also be written as $\Tr \left ( \ketbra{0}{0}_{out} \, \ketbra{\psi_{\tau(N)}}{\psi_{\tau(N)}} \right)$, which is at least $1 - \omega_{N,r-1}$. This implies that
\[
	\eps \geq \frac{1 - \omega_{N,r-1}}{\poly(N)}
\]


\end{proof}


