%!TEX root = main.tex

\section{The VTM $V_{UPC}$}
\label{sec:vtm_upc}

We now specify the VTM $V_{UPC}$, which interacts with $\kappa_R$ provers. The VTM is specified in high level pseudocode in Figure~\ref{fig:vtm}. It receives input $(1^n,w,\lambda)$, where $\lambda$ is interpreted as a tuple $(G,V_{final},M,r)$ where $G$ is a Gate Turing Machine, $V_{final}$ is another VTM, $M$ is a nondeterministic Turing machine, and $r$ is an integer written in binary. The input string $w$ is used to determine all random choices made by $V_{UPC}$.

\begin{center}
\begin{mdframed}
    Input: $(1^n,w,G,V_{final},M,r)$
    \begin{itemize}
    	\item If $r = 1$, run the VTM specified by $V_{final}$ on input $(1^n,w,M)$.
	
		\item If $r > 1$, run each of the following subroutines with probability $1/4$: \textbf{Stabilizer check}, \textbf{Gate check}, \textbf{Input check}, and \textbf{Output check}.
%			do the following. Using the string $w$, execute one of the following subroutines: \emph{Stabilizer check}, \emph{Propagation check}, \emph{Input check}, and \emph{Output check}, described in Figures~\ref{fig:pauli_check},~\ref{fig:prop_check},~\ref{fig:input_check}, and Figure~\ref{fig:output_check} respectively.
		\end{itemize}
\end{mdframed}

\begin{figure}[H]
\caption{The VTM $V_{UPC}$}
\label{fig:vtm}
\end{figure}
\end{center}

Fix integers $n, r$, and fix $\lambda = (G_{UPC},V_{NV},M,r)$. Recall from Section~\ref{sec:vtm} that a VTM $V_{UPC}$ specifies verifier circuits $C_Q^{(n)}(\lambda)$ and $C_A^{(n)}$. In a slight abuse of notation, we use $V_{UPC}^{(n,r)}$ to denote $(C_Q^{(n)}(\lambda),C_A^{(n)})$. Let $\Protocol_{n,r}$ denote the protocol that is executed by this verifier. 

We will show that provers succeeding in the protocol $\Protocol_{n,r}$ with high enough probability must, up to local isometries, share a history state of the simcom game $\mathscr{Z}_{N,r-1}$ whose verifier is $V_{UPC}^{(N,r-1)}$ where $N = 2^n$. This in turn allows us to relate the value of $\Protocol_{n,r}$ to the simcom value of $\mathscr{Z}_{N,r-1}$. This is the main idea behind the proof of Proposition~\ref{prop:UPC_soundness}.


The argument proceeds in two stages. In the first stage, we analyze a VTM $V_H$ that is a modification of $V_{UPC}$: 

\begin{center}
\begin{mdframed}
    Input: $(1^n,w,G,V_{final},M,r)$
    \begin{itemize}
    	\item Run each of the following subroutines with probability $1/3$: \textbf{Gate2 check}, \textbf{Input2 check}, and \textbf{Output2 check}.
%			do the following. Using the string $w$, execute one of the following subroutines: \emph{Stabilizer check}, \emph{Propagation check}, \emph{Input check}, and \emph{Output check}, described in Figures~\ref{fig:pauli_check},~\ref{fig:prop_check},~\ref{fig:input_check}, and Figure~\ref{fig:output_check} respectively.
		\end{itemize}
\end{mdframed}

\begin{figure}[H]
\caption{The VTM $V_H$}
\label{fig:vtm_h}
\end{figure}
\end{center}

Observe that $V_H$ is the same as $V_{UPC}$ except it does not run the VTM $V_{final}$ when $r = 1$, and furthermore it runs a different set of subroutines: \textbf{Gate2 check}, \textbf{Input2 check}, and \textbf{Output2 check}. We present and analyze these subroutines first; we will restrict ourselves to \textbf{honest Pauli strategies}, in which there is a specific prover (called the \textbf{honest Pauli prover}) that is only asked to perform Pauli measurements, and its measurement operators are indeed the honest ones.

We will show that honest Pauli strategies passing the protocol $\Protocol^H_{n,r}$ corresponding to $V_H$ with high enough probability must involve a history state for $\mathscr{Z}_{N,r-1}$.

The second stage of the argument will then show that the \textbf{Stabilizer check} subroutine of $V_{UPC}$ will essentially force a set of $7$ provers to encode an honest Pauli prover using an error correcting code. The subroutines \textbf{Gate check}, \textbf{Input check}, and \textbf{Output check} will be the same as those in $V_H$ except that the messages sent to the honest Pauli prover will now be distributed to these $7$ provers. The value of a strategy in $\Protocol_{n,r}$ will then be related to the value of the corresponding honest Pauli strategy in $\Protocol^H_{n,r}$.


\paragraph{Description of the subroutines}

Each of the subroutines of $V_{UPC}$ and $V_H$ follows a similar structure, summarized in Figure~\ref{fig:check_structure}. For simplicity, we give an ``operational'' description of the subroutines in the sections below, with the understanding that each should be broken down into three phases, as described in the figure.

\vspace{10pt}
\begin{center}
\begin{mdframed}
Inptut: $(1^n,w,G,V,M,r)$\\
  $w$ is a random string, $G$ a GTM, $V$ a VTM, $M$ a NTM, and $r$ the level of the verifier.\\
Each subroutine is decomposed in three phases. Each phase reads some tapes of the VTM and writes on some others. The phases are the following: 
	\begin{enumerate}
		\item (\textbf{ClockMeasurement}) In this phase the subroutine writes the description of a cicruit describing a quantum measurement on the measurement specification tape. The measurement applies to a clock register $\sC$. To describe the measurements, for any integer $t$ we use the notation 
$$\ket{\pm_{t,t'}} \,=\, \frac{1}{\sqrt{2}}\big(\ket{t}\pm\ket{t'}\big)\;.$$
If $t'$ is not specified it is understood that $t'=t+1$.
	\item (\textbf{GenQuestions}) In this phase the subroutine has access to the measurement outcome tape, and writes questions on the player question tape. 
	\item (\textbf{CheckAnswers}) In this phase the subroutine has access to the player answer tape, and writes on the referee decision tape. 
	\end{enumerate}    
\end{mdframed}

\end{center}
\begin{figure}[H]
\caption{Template for each of the subroutines of $V_{UPC}$ and $V_H$}
\label{fig:check_structure}
\end{figure}

\paragraph{Notation} 
Fix integers $n, r > 1$. In what follows, we let $G = G_{UPC}$, $V = V_{NV}$, and $M$ be some fixed nondeterministic Turing machine. For notational clarity we will sometimes omit mention of the input parameters $(G,V,M)$ and treat them as fixed. The VTMs $V_H$ and $V_{UPC}$ take input $(1^n,w,r)$, where $w$ is a string that is used to make all random choices of the VTMs. $r$ is an integer to indicate the ``level'' for the verifier. 


\subsection{Analyzing $V_H$ with honest Pauli strategies}

We now analyze the protocol $\Protocol_{n,r}^H$ that corresponds to the verifier specified by $V_H$ on input $(1^n,w,G,V,M,r)$. We call this verifier the $r$-th level verifier. 

\paragraph{Provers}
The number of provers that $V_H$ interacts with depends on its input in the following way: since $G = G_{UPC}$, we know that $UPC_{N,r-1} = CKT(G,1^N,r-1)$ is protocol circuit that is computed by the GTM $G$ on input $(1^N,r-1,\cdot)$. We call the verifier in $UPC_{N,r-1}$ the $(r-1)$-th level verifier.

Suppose that $UPC_{N,r-1}$ involves a set $\cP_{r-1}$ of $\kappa_{r-1}$ provers. The $r$-th level verifier then interacts with a set $\cH_r$ of $\alpha_r = \kappa_{r-1} + 1$ provers. These provers are labeled
\begin{itemize}
	\item $PV$: This prover plays the role of the verifier in the protocol described by $C_{N,r-1}$. 
	\item $PP_1,\ldots,PP_{\kappa_{r-1}}$: These provers play the role of the $\kappa_{r-1}$ provers in $C_{N,r-1}$.
\end{itemize}
We use the label $P$ to refer to an arbitrary prover $P\in\cH_r$. Questions to and answers from the provers are denoted  by $q_V$, $q_{P,1},\ldots,q_{P,\kappa_{r-1}}$, and $a_V$, $a_{P,1},\ldots,a_{P,\kappa_{r-1}}$, respectively, where the subscript indicates the label of the prover. Furthermore, the provers' private registers are labeled $\sP_V, \sP_{P,1},\ldots,\sP_{P,\kappa_{r-1}}$ where the subscripts have the same meaning.

%The subroutines all take the same input $(1^n,w,G,V,M,r)$. $w$ is a string that is used to make all random choices. $r$ is an integer that indicates a ``level'' for the verifier. It is used to parametrize a set $\mathcal{P}_r$ of $\kappa_R$ provers, each playing different roles. 

%The subroutines describe tests that are to be performed by the verifier in the protocol $UPC_{n,r}$. We call this the $r$-th level verifier. The tests are meant to enforce that the provers hold a history state for the simcom protocol described by $UPC_{N,r-1}$ where $N = 2^n$. 
%that would be carried out by the $(r-1)$-th level verifier and the set of provers $\mathcal{P}_{r-1} \subseteq \mathcal{P}_r$. 

%The provers in the set $\mathcal{P}_r$ have the following labels and associated roles:
%\begin{itemize}
%	\item $PV$: This prover plays the role of the verifier in the simcom game described by $UPC_{N,r-1}$. In this first stage of the analysis, we assume $PV$ is an honest Pauli prover.
%	\item $PP_1,\ldots,PP_{\kappa_{r-1}}$: These provers play the role of the $\kappa_{r-1}$ provers $\mathcal{P}_{r-1}$ that the $(r-1)$-th level verifier interacts with.
%%	\item $PA$: This is an ancilla prover
%%	\item $PA_1,\ldots,PA_{\kappa_{r-1}}$: These are ancilla provers.
%\end{itemize}
%We match the ancilla provers with the other provers in $\mathcal{P}_r$ in the following way: the ancilla prover corresponding to $PV$ is $PA_V$, and the ancilla prover corresponding to $PP_i$ is $PA_i$ for all $i$. 
%We let $\mathcal{R}_r$ denote the set $\{PV,PP_1,\ldots,PP_{\kappa_{r-1}} \} \subset \mathcal{P}_r$ to denote the set of non-ancilla provers. 
%We order the provers in $\mathcal{P}_r$ for notational convenience: $PV < PP_1 < \cdots < PP_{\kappa_{r-1}}$. 


%In what follows, we use the standard notation $\sC,\sV_{in},\sV_{work}, \sK_1, \sE_j$, etc., to refer to registers that $UPC_{n,r}$ acts on. To refer to registers that are involved in the $(r-1)$-th level interaction as described by $UPC_{N,r-1}$, we use the hat symbol, such as $\what{\sC}$, $\what{\sV}_{in},\what{\sV}_{work}$, and $\{ \what{\sM}_i \}_i$.

% we use the notation $\sC,\sV_{in},\sV_{work}$, and $\sM_i$ introduced in Section~\ref{sec:specs} to refer to registers on which the verifier in $UPC_{n,r}$ acts on. In addition, we write $\what{\sC}$, $\what{\sV}_{in},\what{\sV}_{work}$, and $\{ \what{\sM}_i \}_i$ to denote the registers that $UPC_{N,r-1}$ acts on. We let $\what{\sM}$ denote the union of $\{ \what{\sM}_i \}_i$. 



\paragraph{Honest Pauli strategy} 
The protocol circuit $UPC_{n,r}$ has registers $\sO \sK_1 \sK_2 \sC \sV \sM \sE_1 \sE_2$ that belong to the verifier. We will use a hat on these register labels to denote the same registers for the exponentially bigger protocol circuit $UPC_{N,r-1}$, such as $\what{\sO}$, $\what{\sV}$, $\what{\sE}_1$, etc.

A strategy $\strat = (\rho,\{M_i\})$ for $\Protocol_{n,r}^H$ is an \textbf{honest Pauli strategy} if
\begin{enumerate}
	\item The prover $PV$'s private register $\sP_V$ contains the registers $\what{\sO} \what{\sK}_1 \what{\sK}_2 \what{\sC} \what{\sV} \what{\sM} \what{\sE}_1 \what{\sE}_2$ that are identical in dimension to those in the verifier in the protocol circuit $UPC_{N,r-1}$, and
	\item $PV$'s measurement operators are honest Pauli measurements.
\end{enumerate}
Recall that the state $\rho$ is on $\alpha_r + 1$ registers: the $r$-th level verifier holds register $\sC$, and prover $P \in \cH_r$ holds register $\sP_P$.

%that are like those in $UPC_{N,r-1}$, and furthermore its measurement operators correspond to honest Pauli measurements on these registers. 


%
%\subsection{Propagation Check}
%
%\begin{center}
%\begin{mdframed}
%    Input: $(T,P,\reg{C},\{g_1,\ldots,g_T\})$, where $T$ is an integer, $P$ is the label for a prover, $\reg{C}$ the label for a clock register,  $g_1,\ldots,g_T$ question symbols. 
%	\begin{enumerate}
%		\item (\textbf{ClockMeasurement}) Select a uniformly random integer $t\in\{1,\ldots,T\}$. Write on the measurement specification tape a description for the circuit $C_M$ that implements the following measurement on clock register $\reg{C}$: 
%\[
%	\{ 	\Pi^0 = \ketbra{+_t}{+_t}, 
%	\Pi^1 = \ketbra{-_t}{-_t}, 
%	\Pi^2 = \Id - \Pi^0 - \Pi^1 \}\;.
%\]	
%Let $s\in \{0,1,2\}$ denote the result of the measurement.
%	\item (\textbf{GenQuestions}) Set $q_P = g_t$.
%		\item (\textbf{CheckAnswers}) If $s = 2$, then accept. Otherwise, accept if and only if $a_P = s$. 
%	\end{enumerate}    
%\end{mdframed}
%
%\end{center}
%\begin{figure}[H]
%\caption{Propagation Check}
%\label{fig:prop_check_0}
%\end{figure}
%
%
%
%
%\paragraph{Honest Propagation Check strategy} An honest Propagation Check strategy is one in which the shared state is a history state of the computation $G_T\cdots G_1$, where $G_i$ is the binary observable measured by the prover on question $g_i$. In other words, it has the following form:
%\[
%	\frac{1}{\sqrt{T}} \sum_{t = 0}^{T} \ket{t}_{\reg{C}} \otimes G_t\cdots G_1 \ket{\psi_0}_{\sP}\;,
%\]
%for some state $\ket{\psi_0}_{\sP}$.
%
%\begin{lemma}	
%\label{lem:prop_check_0}
%\leavevmode
%\begin{enumerate}
%\item (\textbf{Completeness}) An honest Propagation strategy passes the $\textbf{Propagation Check}$ subprotocol with probability $1$. 
%\item (\textbf{Soundness}) Any strategy that passes the $\textbf{Propagation Check}$ subprotocol with probability at least $1 - \eps$ is $\delta$-close to an honest Propagation Check strategy, for some $\delta = \poly[N;\eps]$.
%\end{enumerate}
%\end{lemma}
%




%%%%%%%%%%%%%%%%%%%%%%%%%%		GATE CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Gate2 check}
\label{sec:prop_check}

%\tnote{I renamed this gate check because I wanted a more general ``propagation check''. But I did not edit the section}

\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,G,V,M,r)$
	\begin{enumerate}
		\item Select a uniformly random integer $t\in\{1,\ldots, \tau(N)\}$, where $N = 2^n$, and measure the clock register $\sC$ using the POVM 
\[
	\{ 	\Pi^0 = \ketbra{+_t}{+_t}, 
	\Pi^1 = \ketbra{-_t}{-_t}, 
	\Pi^2 = \Id - \Pi^0 - \Pi^1 \}\;.
\]	
Let $s \in \{0,1,2\}$ denote the result of the measurement. If $s = 2$, accept.
%		\item (\textbf{ClockMeasurement}) Select a uniformly random integer $t\in\{1,\ldots, \tau(N)\}$, where $N = 2^n$. Write on the measurement specification tape a description for the circuit $C_M$ that implements the following measurement, which is a tensor product of a two-outcome POVM $F$ acting on clock register $\reg{C}_p$ and a three outcome POVM $\Pi_t$ acting on clock register $\reg{C}_{mip}$: 
%\[
%	\{F^0 = \ketbra{0}{0}, F^1 = \Id - F^0 \}\;,
%\]
%\[
%	\{ 	\Pi^0 = \ketbra{+_t}{+_t}, 
%	\Pi^1 = \ketbra{-_t}{-_t}, 
%	\Pi^2 = \Id - \Pi^0 - \Pi^1 \}\;.
%\]	
%Let $(p,s) \in \{0,1\} \times \{0,1,2\}$ denote the result of the six-outcome measurement $F \otimes \Pi_t$.

	\item Execute the GTM $G$ to compute $g = G(N,r-1,t)$. 
	\item If $g$ is a Toffoli gate or doubled Hadamard gate, then run the \textbf{Toffoli Check} or \textbf{Hadamard Check} with $PV$, respectively. 
	\item If $g$ is a prover question to prover $P$, then set $q_P = \star$. Accept only if the answer $a_P = s$.
%	
%	
%	\item (\textbf{CheckAnswers}) If $s = 2$, then accept. Otherwise:
%		\begin{itemize}
%			\item If $g$ is a Toffoli gate or doubled Hadamard gate, check the answers according to \textbf{Toffoli Check} or \textbf{Hamadard Check}, respectively. 
%			\item If $g$ is a prover question to prover $P$, then accept only if $a_P = s$. 
%		\end{itemize}
	\end{enumerate}    
\end{mdframed}

\end{center}
\begin{figure}[H]
\caption{Gate Check}
\label{fig:prop_check}
\end{figure}

The procedures  \textbf{Toffoli Check} and \textbf{Hadamard Check} are taken from~\cite{ji2016compression}. For completeness, we include a description. A Toffoli or doubled Hadamard gate $g$ returned by the GTM $G$ always comes together with labels for a set of qubits on which the gate acts on. These qubits refer to qubits on which the $(r-1)$-level verifier of $UPC_{N,r-1}$ acts on. 

%In the protocol executed by the $r$-level verifier $UPC_{n,r}$, the qubits are distributed among the provers. In the description of the tests, we refer to the ``prover holding qubit $u$'' to specify the appropriate prover. For example, if $u$ is a qubit in $\reg{V}_{r-1,in}$ then the prover is $PV$; if it is a qubit in $\reg{M}_{r-1,j}$ then the prover is $PP_j$, etc. 

%In the Hadamard and Toffoli Checks, the verifier will send to each prover a pair of questions: an EPR question and a Pauli question (as done in the Pauli Check subroutine). This is because the prover should not be able to distinguish between whether it is performing the Pauli Check or the Gate Check (or any other check). Thus the ``true'' question in these tests is the Pauli question, but they will be augmented with a random EPR check question. Only the provers' answers to the Pauli questions are taken into consideration.

\vspace{10pt}
\begin{center}
\begin{mdframed}
    \textbf{Toffoli Check} \\
	Input: $(1^n,w,r,s,g)$, where $g$ is a Toffoli gate acting on qubits $u_1,u_2,u_3$ of $UPC_{N,r-1}$, and $s \in \{0,1\}$. 
	\begin{enumerate}
		\item Sample $\alpha \in \{0,1\}$ uniformly at random, and accept if $\alpha = 1$. Otherwise, continue.
		\item Set $q_V = (Z_{u_1},Z_{u_2},X_{u_3})$. Let $a_V = (a_1,a_2,a_3)$ be the three answer bits corresponding to the Pauli questions.

		\item Reject if $a_1 = a_2 = 1 \wedge s \oplus a_3 = 1$, or $a_1 a_2 = 0 \wedge s = 1$.
		\item Accept otherwise.
	\end{enumerate}    
    \vspace{10pt}
\textbf{Hadamard Check} \\
	Input: $(1^n,w,r,s,g)$, where $g$ is a double Hadamard gate acting on qubits $u_1,u_2$ of $UPC_{N,r-1}$, and $s \in \{0,1\}$.

	\begin{enumerate}
		\item Sample $\alpha \in \{0,1\}$ uniformly at random.
		\item If $\alpha = 0$, set $q_V = ( X_{u_1} X_{u_2}, Z_{u_1} Z_{u_2})$. Let $a_1,a_2$ be the two answer bits corresponding to the Pauli questions. Reject if $s \oplus a_1 = s \oplus a_2 = 1$, accept otherwise.
		
		\item If $\alpha = 1$, set $q_V = (X_{u_1}Z_{u_2},Z_{u_1} X_{u_2})$. Let $a_1,a_2$ be the two answer bits. Reject if $s \oplus a_1 = s \oplus a_2 = 1$ and accept otherwise.
	\end{enumerate}    
\end{mdframed}

\end{center}
\begin{figure}[H]
\caption{Toffoli and Hadamard Checks}
\label{fig:toffoli_hadamard_check}
\end{figure}

\begin{lemma}[Hadamard and Toffoli Check~\cite{ji2016compression}]
\label{lem:ver_gate_check}
	Let $\strat$ be an honest Pauli strategy with $\rho_{\sC \sP}$ as the shared state in \textbf{Hadamard Check} (resp. \textbf{Toffoli Check}). Let $U$ denote a doubled Hadamard gate (resp. Toffoli gate). Then the \textbf{Hadamard Check} (resp. \textbf{Toffoli Check}) rejects with probability 
	
	\[
		\frac{1}{4} \Tr_{\rho} \paren{ \Id - J_t \otimes U }
	\]
	where $J_t$ denotes the following unitary acting on $\sC_{mip}$:
	\[
		J_t = \Id - 2\ketbra{-_t}{-_t}.
	\]
%	where $\ket{-_t} = \frac{1}{\sqrt{2}} \left( \ket{t} - \ket{t+1} \right)$.
\end{lemma}

\paragraph{The high level}  At a high level, this test  proceeds as follows. The $r$-th level verifier samples a random time $t \in \{1,\ldots,\tau(N)\}$, and computes the $t$-th gate $g_t$ of $UPC_{N,r-1}$ using the GTM $G = G_{UPC}$. Most of the time, the gate $g_t$ is a (doubled) Hadamard or Toffoli gate that is computed by the $(r-1)$-th level verifier $UPC_{N,r-1}$. To check the propagation of such a gate, the $r$-level verifier executes the corresponding Hamadard or Toffoli Check (see Figure~\ref{fig:toffoli_hadamard_check}) to generate the corresponding questions. In some cases the gate $g_t$ is not a gate, but rather it represents the $i$-th prover's unitary. In that case, prover $i$ is sent the question $\star$.  

Any prover who was not explicitly sent a question is sent a null question, denoted by $\bot$.

\paragraph{Question types} There are two types of questions in this test: Pauli operations and a prover reflection question $\star$.

\paragraph{Honest Gate Check strategy} 
\hnote{An honest gate check strategy is to actually leave the luggage on the jetway when they ask you to, instead of sneakily taking it on the plane with you... ahem....}

For all $0 \leq t \leq \tau(N)$, let $g_t = G(N,r-1,t)$. An honest Pauli strategy $\strat$ is an honest Gate Check strategy if the shared state $\ket{\psi}_{\sC \sP \sR}$ is a history state of the computation $g_1g_2\cdots g_{\tau(N)}$. In other words, it has the following form:
\[
	\ket{\psi}_{\sC \sP \sR} = \frac{1}{\sqrt{\tau(N) + 1}} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC} \otimes \ket{\psi_t}_{\sP \sR}
\]
where for all $t$, the state $\ket{\psi_t}_{\sP \sR}$ is defined to be $g_t \ket{\psi_{t-1}}_{\sP \sR}$ with $g_t$ being either a doubled Hadamard, a Toffoli, or a prover reflection acting on the correct registers. The state $\ket{\psi_0}$ is arbitrary.  %The register $\sP$ itself is decomposed into a tensor product of registers $\bigotimes_P \sP_P$. 

%Since $\strat$ is an honest Pauli Check strategy, the register $\sP_P$ corresponding to a non-ancilla prover $P \in \mathcal{R}_r$ has additional structure: it includes two registers $\sB_P' \sB_P$. We will further refine the naming of these registers.

%The register $\sB_{PV}$ (belonging to prover $PV$) consists of $N$ qubits, and is divided into three registers $\sC_{r-1}, \sV_{r-1,in}, \sV_{r-1,work}$, each of size $N/3$ qubits \hnote{Subject to change...}. 
%For all $i$, the $\sB_{PP_i}$ register also has the name $\sM_{r-1,i}$. From this point on, we will not refer to the $\sB_P$ registers and use these new names.

\begin{lemma}	
\label{lem:prop_check}
\leavevmode
\begin{enumerate}
\item (\textbf{Completeness}) An honest Gate Check strategy passes the $\textbf{Gate check}$ subprotocol with probability $1$. 
\item (\textbf{Soundness}) All honest Pauli strategies $\strat$ that pass the $\textbf{Gate check}$ subprotocol with probability at least $1 - \eps$ are $\delta$-close to an honest Gate Check strategy for some $\delta = \poly[N;\eps]$.
\end{enumerate}
\end{lemma}
\begin{proof}
	The completeness statement of the Theorem is straightforward. We now argue about the soundness statement. This analysis largely follows that of~\cite{ji2016compression}. 
	
	Let $\ket{\psi}_{\sC \sP \sR}$ denote the shared state in the honest Pauli strategy $\strat$, and let $\rho = \ketbra{\psi}{\psi}$. By assumption, the rejection probability with $\rho$ as the shared state is at most $\eps$.
	
%	Let $\Pi = \ketbra{0}{0}_{\sC_p}$, the projection onto the all zeroes state of $\sC_p$. Since $\strat$ is an honest Pauli strategy, we have that $\Tr_\rho (\Pi) \geq 1/\poly(N)$. Let 
%	\[
%		\rho_0 = \frac{\Pi \rho \Pi}{\Tr_\rho(\Pi)} = \frac{\Pi \ketbra{\psi}{\psi} \Pi}{\bra{\psi} \Pi \ket{\psi}}.
%	\]
%	The probability that the \textbf{Gate Check} subroutine rejects when the shared state is $\rho_0$ instead of $\rho$ is at most $\eps' = \poly(N) \eps$. 
	
%	Suppose now that the shared state in the \textbf{Gate Check} is $\rho_0$. 
	
	We give an expression for the rejection probability. For any $t \in \{0,1,\ldots,\tau(N)\}$, let $r_t$ denote the rejection probability conditioned on the verifier choosing $t$. If $g_t$ corresponds to a doubled Hadamard gate or a Toffoli gate, by Lemma~\ref{lem:ver_gate_check} the rejection probability is 
	\[
		r_t = \frac{1}{4} \Tr_{\rho} \left ( \Id - J_t \otimes g_t \right ).
	\]
	If $g_t$ corresponds to a prover question to prover $PP_j$, then the rejection probability is equal to
	\[
		r_t = \frac{1}{2} \Tr_{\rho} \left ( \Id - J_t \otimes g_t \right ).
	\]
	where we define $g_t$ to be prover $PP_j$'s reflection upon the question $\star$. The overall rejection probability satisfies
	\[
		\eps' \geq \E_t r_t  \geq \frac{1}{4} \E_t \Tr_{\rho} \left ( \Id - J_t \otimes g_t \right ).
	\]	
	In other words, we have
	\[
		\E_t \Tr_{\rho'} \left ( \ketbra{-_t}{-_t} \right ) \leq \eps'
	\]
	where we define
	\[
		\rho' = Q^\dagger \rho Q, \qquad Q = \sum_t \ketbra{t}{t}_{\sC_{mip}} \otimes g_t \cdots g_1.
	\]
Thus we have
	\[
		\Tr_{\rho} \E_t  \left ( Q\ketbra{-_t}{-_t}Q^\dagger  \right) \leq \eps'.
	\]
	For reasons that will become clear soon, we will let $H_{prop}$ denote the operator $\E_t  \left ( Q\ketbra{-_t}{-_t}Q^\dagger  \right)$. Notice that $H_{prop}$ is positive semidefinite, has smallest eigenvalue $0$ and the second smallest eigenvalue is at least $1/\poly(N)$. Using Lemma~\ref{lem:closeness_to_groundspace}, we have that $\rho$ is $\poly[N;\eps]$-close to a pure state $\ketbra{\theta}{\theta}$ satisfying $H_{prop} \ket{\theta} = 0$. 
	
	Now notice that $H_{prop}$ resembles the propagation term of the Feynman-Kitaev Hamiltonian that checks the propagation of the computation $g_1 g_2 \cdots g_{\tau(N)}$~\cite{kitaev2002classical}. Thus any state $\ket{\theta}$ in the kernel of $H_{prop}$ must be a history state $\ket{\theta}_{\sC \sP \sR} = \frac{1}{\sqrt{\tau(N)+1}} \sum_t \ket{t}_{\sC} \otimes \ket{\theta_t}_{\sP \sR}$ where $\ket{\theta_t} = g_t \ket{\theta_{t-1}}$.
	
	This concludes the proof.
	
%	We can thus construct a new honest Pauli strategy $\strat'$ where the prover operators are the same as in $\strat$, and the shared state $\ket{\psi'}_{\sC \sP \sR}$ is such that $\Pi \ket{\psi'} = \ket{0}_{\sC_{mip}} \otimes \ket{\theta}$ (i.e. is a history state for the computation $g_1 g_2 \cdots g_{\tau(N)}$) and otherwise has the form~\eqref{eq:honest-psi}.We have that $\| \ket{\psi} - \ket{\psi'} \|^2 \leq \poly[N;\eps]$, so $\strat'$ is $\poly[N;\eps]$-close to $\strat$, and furthermore $\strat'$ is an honest Gate Check strategy. This concludes the proof. %\hnote{We will need to write what it means for two strategies to be close.}
%	The propagation term has spectral gap $1/\poly(N)$ and its zero eigenspace is exactly the space of history states of the aforementioned computation.
	
	%This, combined with Lemma~\ref{lem:closeness_to_groundspace}, implies that $\rho_0$ is $\poly[N;\eps]$-close to a history state of the computation $g_1g_2\cdots g_{\tau(N)}$.%\tnote{should the last implication refer to a theorem?}
	
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%		INPUT CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Input2 check}
\label{sec:input_check}


\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,G,V,M,r)$ \\
	\begin{enumerate}
		\item Measure the $\sC$ register in the computational basis. Let $t \in \{1,\ldots,\tau(N)\}$ be the outcome. If $t \neq 0$, accept.
		
		\item Pick a random register $\what{\sR} \in \{ \what{\sV}_{in}, \quad \what{\sO} \what{\sV}_{work} \what{\sM} \what{\sK}_1 \what{\sK}_2, \quad \what{\sE}_1 \what{\sE}_1', \quad \what{\sE}_2 \what{\sE}_2' \}$.
		\begin{enumerate}
			\item If $\what{\sR} = \what{\sV}_{in}$, then pick a random qubit index $j \in \supp(\what{\sV}_{in})$. Set $q_V = Z_j$. If $a_V$ is equal to the $j$'th bit of the string that is $(G,V,M)$ padded by $0$, then accept. Otherwise, reject.
			\item If $\what{\sR} = \what{\sO} \what{\sV}_{work} \what{\sM} \what{\sK}_1 \what{\sK}_2$, then pick a random qubit index $j \in \supp(\what{\sR})$. Set $q_V = Z_j$. If $a_V = 0$, then accept. Otherwise, reject.
			\item If $\what{\sR} = \what{\sE}_k \what{\sE}_k'$ for $k \in \{1,2\}$, then 
			\begin{enumerate}
				\item Pick a random prover index $i \in \{1,\ldots,\kappa_{r-1}\}$. 
				\item Pick a random qubit index $j \in \supp(\what{\sE}_{k,i})$.
				\item Pick a random $D \in \{X,Z\}$.
				\item Set $q_V = D_{kij}$ and $q_{PP_i} = D_{kj}$. Accept if $a_V = a_{PP_i}$ and reject otherwise.
			\end{enumerate}
		\end{enumerate}
	\end{enumerate}    
\end{mdframed}
\end{center}
\begin{figure}[H]
\caption{Input Check}
\label{fig:input_check}
\end{figure}

\paragraph{The high level} First, we will assume that the strategy is an honest \textbf{Gate Check} strategy (and thus an honest Pauli strategy), meaning that the provers will share a history state of the protocol specified by $UPC_{N,r-1}$. The \textbf{Input Check} subroutine will check that the first snapshot of the history state is properly initialized.

% the prover $PV$ (which is supposed to play the role of the verifier of $UPC_{N,r-1}$) has the $\what{\sV}_{in}$ register initialized to the input $(G,V,M)$, and $\what{\sO} \what{\sV}_{work} \what{\sM} \what{\sK}_1 \what{\sK}_2$ set to zeroes. Furthermore, the subroutine will check that the $PV$ shares the maximally entangled state with $PP_i$ in the $\what{\sE}_{1,i} \what{\sE}_{2,i}$ registers.

%the $PP_i$ prover has the message register $\sM_{r-1,i}$ set to all zeroes.

\paragraph{Question types} All provers are sent single qubit Pauli questions.

\paragraph{Honest Input Check strategy}
An honest Gate Check strategy $\strat$ with shared state
\[
	\ket{\psi}_{\sC \sP \sR} = \frac{1}{\sqrt{\tau(N) + 1}} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC} \otimes \ket{\psi_t}_{\sP \sR}
\]
is an honest Input Check strategy if the initial state $\ket{\psi_0}_{\sP \sR}$ is such the
$\what{\sV}_{in}$ register is in the state $\ket{G,V,M,0}$, the $\what{\sO} \what{\sV}_{work} \what{\sM} \what{\sK}_1 \what{\sK_2}$ registers are all zero, and $\what{\sE}_1 \what{\sE}_1' \what{\sE}_2 \what{\sE}_2'$ registers are in the state $\ket{\Phi}_{\what{\sE}_1 \what{\sE}_1'} \otimes \ket{\Phi}_{\what{\sE}_2 \what{\sE}_2'}$. Here, the $\what{\sE}_1 \what{\sE}_2$ registers are held by the $PP_i$ provers. In other words, the $UPC_{N,r-1}$ protocol circuit is properly initialized.

Recall that the registers $\what{\sO} \what{\sK}_1 \what{\sK}_2 \cdots$ are held by the honest Pauli prover $PV$.
%For all $0 \leq t \leq \tau(N)$, let $g_t = G(N,r-1,t)$. A strategy $\strat$ is an honest Propagation strategy if the Pauli operators are trusted and the shared state has the following form:
%where $\ket{\psi_t}_{\sP \sE} = g_t \ket{\psi_{t-1}}_{\sP \sE}$ with $g_t$ being either a doubled Hadamard, a Toffoli, or a prover reflection. The state $\ket{\psi_0}$ is arbitrary.



\begin{lemma}	
\label{lem:input_check}
\leavevmode
\begin{enumerate}
	\item (\textbf{Completeness}) An honest Input Check strategy passes the $\textbf{Input Check}$ subprotocol with probability $1$. 
	\item (\textbf{Soundness}) There exists a $\delta = \poly[N;\eps]$ such that all honest Gate Check strategies $\strat$ that pass the $\textbf{Input Check}$ subprotocol with probability at least $1 - \eps$ are $\delta$-isometric to the honest Input Check strategy.
\end{enumerate}
\end{lemma}
\begin{proof}
The completeness statement of the Theorem is straightforward. We now argue about the soundness statement.

Let $\ket{\psi}_{\sC_p \sC_{mip} \sP \sR}$ denote the shared state. Let $\rho = \ketbra{\psi}{\psi}$. Since the strategy $\strat$ is an honest Gate Check strategy (and therefore an honest Pauli Check strategy), we have that
\[
\ket{\psi}_{\sC\sP \sR} = \frac{1}{\sqrt{\tau(N)+1}} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC} \otimes \ket{\psi_t}_{\sP \sR}
\]
Let $\Pi = \ketbra{0}{0}_{\sC}$. These two items imply that $\Tr_\rho (\Pi) \geq 1/\poly(N)$. Let 
\[
	\rho_{0} = \frac{\Pi \rho \Pi}{\Tr_\rho (\Pi)} = \ketbra{0}{0}_{\sC} \otimes \ketbra{\psi_0}{\psi_0}_{\sP \sR}.
\]
The probability that \textbf{Input Check} rejects when the shared state is $\rho_{0}$ instead of $\rho$ is at most $\eps' = \poly(N) \eps$. 

Suppose now that the shared state in \textbf{Input Check} is $\rho_{0}$. \hnote{Need to update this proof...}

%Let $\sX = \sV_{r-1} \setminus \sC_{r-1}$ (i.e. all the qubits of $\sV_{r-1}$ except those in $\sC_{r-1}$) and $\sY = \sP \sR \setminus \sX$ (i.e. all the qubits of $\sP \sR$ except those in $\sX$). Consider an ordering of the qubits in the registers $\sX$  so that $\sV_{r-1,in}$ goes first, followed by the rest of the registers. Let $x$ denote the string of length $|\sV_{r-1,in}|$ that is $(G,V,M)$ padded with zeroes. The probability of rejection is then
%	\begin{equation}
%		\Tr_{\rho_{00}} ( H_{init} ) \leq \eps'
%		\label{eq:init}
%	\end{equation}
%	where we define 
%	\[
%		H_{init} = \frac{1}{\left | \sX \right|} \left ( \sum_{i \in \sV_{r-1,in}} \ketbra{\overline{x}_i}{\overline{x}_i}_i +  \sum_{i \notin \sV_{r-1,in}} \ketbra{1}{1}_i \right)
%	\] 
%	where the first sum is over all the qubits in $\sV_{r-1,in}$ and the second sum is over all qubits in $\sX \setminus \sV_{r-1,in}$. We use $\overline{x}_i$ to denote the complement of the bit $x_i$. The subscripts on a projector (such as $\ketbra{1}{1}_i$) indicates which qubit it acts on. We use $|\sX|$ to denote the number of qubits in $\sX$. 
%	
%	Notice that $H_{init}$ resembles the term of the Feynman-Kitaev Hamiltonian that checks if the history state is initialized correctly. The unique eigenvector of eigenvalue $0$ of $H_{init}$ (on the register $\sA$) is the state $\ket{G,V,M,0}$. The inequality in~\eqref{eq:init} and Lemma~\ref{lem:closeness_to_groundspace} implies that
%	\[
%		\Norm{ \ket{\psi_0}_{\sP \sR} - \ket{G,V,M,0}_{\sX} \otimes \ket{\theta}_{\sY} }^2 \leq \poly[N;\eps]
%	\]
%	for some state $\ket{\theta}_{\sY}$.
%	
%	Thus we can construct a new honest Gate strategy $\strat'$ where the prover operators are the same as in $\strat$, and the shared state $\ket{\psi'}_{\sC \sP \sR}$ is such that $\Pi \ket{\psi'} = \ket{0,0}_{\sC} \otimes \ket{G,V,M,0}_{\sX} \otimes \ket{\theta}_{\sY}$, and otherwise has the form of an honest Gate strategy. We have that $\| \ket{\psi} - \ket{\psi'} \|^2 \leq \poly[N;\eps]$, so therefore $\strat'$ is $\poly[N;\eps]$-close to $\strat$, and furthermore $\strat'$ is an honest Input Check strategy. This concludes the proof.
	
%	$\Big( \rho_{00} \Big)_{\sV_{r-1} \setminus \{ \sC_{r-1} \}}$ is $\poly(N) \eps'$-close to $\ketbra{G,V,M,0}{G,V,M,0}$. This finishes the proof.

	
%Let $\Big( \rho_0 \Big)_{\sV_{r-1} \setminus \{ \sC_{r-1} \}}$ denote the reduced density matrix of $\rho_{00}$ on the registers $\sV_{r-1} \setminus \{ \sC_{r-1} \}$. 

\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%		OUTPUT CHECK		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Output2 check}
\label{sec:output_check}


\vspace{10pt}
\begin{center}
\begin{mdframed}
    Input: $(1^n,w,G,V,M,r)$
    \begin{enumerate}
		\item Measure the $\sC$ register in the computational basis. Let $t \in \{1,\ldots,\tau(N)\}$ be the outcome. If $t \neq \tau(N)$, accept.
		
		\item Let $j_O$ and $j_{out}$ be the indices of the qubits of the $\what{\sO}$ and $\what{\sV}_{out}$ registers, respectively. For $i \in \{1,\ldots,\kappa_{r-1}\}$, let $j_{i,1},\ldots,j_{i,h}$ denote the indices of the qubits in the $\what{\sK}_{2,i}$ register. 
		\item Set $q_V = (Z_{j_O},Z_{j_{out}},Z_{j_{1,1}},\ldots,Z_{j_{\kappa_{r-1},h}})$. In other words, ask $PV$ to measure its registers $\what{\sO} \what{\sV}_{out} \what{\sK}_2$ in the computational basis. 
		\item For $i \in \{1,\ldots,\kappa_{r-1}\}$, set $q_{PP_i} = \Diamondblack$. 
		\item Let $a_V = (o,b,k_1,\ldots,k_{\kappa_{r-1}})$ where $k_i \in \{0,1\}^{2\log |\cA_i|}$. Let $a_{PP_i} = k_i'$. 
		\item If $o = 0$, then accept.
		\item If there exists an $i$ such that $k_i \neq k_i'$, then accept.
		\item If $b = 1$, then accept. Otherwise, reject. 
	\end{enumerate}    
\end{mdframed}
\end{center}
\begin{figure}[H]
\caption{Output Check}
\label{fig:output_check}
\end{figure}


\paragraph{The high level} The \textbf{Output Check} checks that the last snapshot $\ket{\psi_{\tau(N)}}$ of the history state represents an accepting configuration of the simcom game $UPC_{N,r-1}$. 
%the output qubit (the first qubit of the workspace register) set to $1$ (or close to it). To do so, the subroutine will command the prover $PV$ to measure  qubit $\supp(\sV_{r-1,work})_1$ in the computation basis. 

% post-selects on the clock register $\sR$ in reading the last time $\tau(N)$ of the circuit, and the verifier will ask prover $1$ to measure its first qubit in the computational basis, which should correspond to the output bit of the history state. 

\paragraph{Question types} 
The honest Pauli prover $PV$ is sent multi-qubit Pauli questions. The provers $PP_i$ are all sent the question $\Diamondblack$, where they are supposed to produce teleportation keys.

\begin{lemma}	
\label{lem:output_check}
Let $\omega_{N,r-1}^{SC}$ denote the maximum acceptance probability of the simcom game that is executed by the verifier $UPC_{N,r-1}$ on input $(G_{UPC},V_{NV},M)$. 
\begin{enumerate}
	\item (\textbf{Completeness}) If $\omega_{N,r-1}^{SC} = 1$, then there exists an honest Input Check strategy that passes the Output Check protocol with probability $1$.
	
	\item (\textbf{Soundness}) All honest Input Check strategies pass the Output Chek subprotocol with probability at most 
\[
	1 - \frac{1 - \omega_{N,r-1}^{SC}}{\poly(N)}.
\] 
\end{enumerate}
\end{lemma}
\begin{proof}
The Completeness part of the Theorem statement follows from the fact that one can construct an honest Input Check strategy that corresponds to provers using the perfect strategy that achieves $\omega_{N,r-1} = 1$.

We now argue the Soundness part of the Theorem statement. Let $\ket{\psi}_{\sC \sP \sR}$ denote the shared state. Let the rejection probability with this shared state be $\eps$. 
\hnote{Update...}

\end{proof}



%Since the strategy is an honest Input Check strategy, the shared state (when conditioned on $\sC_p$ register being zero) is a history state of the protocol executed by the verifier $UPC_{N,r-1}$ with a number of provers,
%\[
%\frac{1}{\sqrt{\tau(N) + 1}} \sum_{t = 0}^{\tau(N)} \ket{t}_{\sC_{mip}} \otimes \ket{\psi_t}_{\sP \sR}
%\]
%with the initial snapshot state $\ket{\psi_0}$ being properly initialized to $\ket{G,V,M,0}$ in the $\sV_{r-1} \setminus \{ \sC_{r-1} \}$ registers. Note that the probability of rejection in the protocol described by the history state is 
%\[
%	\Tr \left ( \ketbra{0}{0}_{out} \, \ketbra{\psi_{\tau(N)}}{\psi_{\tau(N)}} \right) \geq 1 - \omega_{N,r-1}.
%\]
%where $\ketbra{0}{0}_{out}$ is the projector onto the state $\ket{0}$ of the first qubit of the workspace register.
%
%Let $\rho = \ketbra{\psi}{\psi}$. Let $\Pi = \ketbra{0}{0}_{\sC_p} \otimes \ketbra{\tau(N)}{\tau(N)}_{\sC_{mip}}$. We have that $\Tr_\rho (\Pi) \geq 1/\poly(N)$. Let
%\[
%\rho_0 = \frac{\Pi \rho \Pi}{\Tr_\rho (\Pi)} = \ketbra{0,\tau(N)}{0,\tau(N)}_{\sC} \otimes \ketbra{\psi_{\tau(N)}}{\psi_{\tau(N)}}.
%\]
%The probability that \textbf{Output Check} rejects when the shared state $\rho_0$ is at most $\eps' = \poly(N) \eps$. The rejection probability when the shared state is $\rho_0$ can also be written as $\Tr \left ( \ketbra{0}{0}_{out} \, \ketbra{\psi_{\tau(N)}}{\psi_{\tau(N)}} \right)$, which is at least $1 - \omega_{N,r-1}$. This implies that
%\[
%	\eps \geq \frac{1 - \omega_{N,r-1}}{\poly(N)}
%\]


\subsection{Concluding the first stage}

We conclude the first stage of the analysis by putting together Lemmas~\ref{lem:prop_check},~\ref{lem:input_check}, and~\ref{lem:output_check} to show the following:

\begin{lemma}
\label{lem:first_stage}
Let $\omega_{N,r-1}^{SC}$ denote the maximum acceptance probability of the simcom game that is executed by the verifier $UPC_{N,r-1}$ on input $(G_{UPC},V_{NV},M)$. 
\begin{enumerate}
	\item (\textbf{Completeness}) If $\omega_{N,r-1}^{SC} = 1$, then there exists an honest Pauli strategy $\strat$ such that $\omega^{*}_\strat(\Protocol^H_{n,r}) = 1$.
	
	\item (\textbf{Soundness}) For all honest Pauli strategies, 
\[
	\omega^{*}_\strat(\Protocol^H_{n,r}) \leq 1 - \frac{1 - \omega_{N,r-1}^{SC}}{\poly(N)}.
\] 
\end{enumerate}
\end{lemma}






